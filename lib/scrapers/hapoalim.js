"use strict";

require("core-js/modules/es.promise");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _moment = _interopRequireDefault(require("moment"));

var _v = _interopRequireDefault(require("uuid/v4"));

var _baseScraperWithBrowser = require("./base-scraper-with-browser");

var _navigation = require("../helpers/navigation");

var _waiting = require("../helpers/waiting");

var _fetch = require("../helpers/fetch");

var _transactions = require("../transactions");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DATE_FORMAT = 'YYYYMMDD'; // eslint-disable-next-line @typescript-eslint/no-namespace

function convertTransactions(txns) {
  return txns.map(txn => {
    const isOutbound = txn.eventActivityTypeCode === 2;
    let memo = '';

    if (txn.beneficiaryDetailsData) {
      const {
        partyHeadline,
        partyName,
        messageHeadline,
        messageDetail
      } = txn.beneficiaryDetailsData;
      const memoLines = [];

      if (partyHeadline) {
        memoLines.push(partyHeadline);
      }

      if (partyName) {
        memoLines.push(`${partyName}.`);
      }

      if (messageHeadline) {
        memoLines.push(messageHeadline);
      }

      if (messageDetail) {
        memoLines.push(`${messageDetail}.`);
      }

      if (memoLines.length) {
        memo = memoLines.join(' ');
      }
    }

    const result = {
      type: _transactions.TransactionTypes.Normal,
      identifier: txn.referenceNumber,
      date: (0, _moment.default)(txn.eventDate, DATE_FORMAT).toISOString(),
      processedDate: (0, _moment.default)(txn.valueDate, DATE_FORMAT).toISOString(),
      originalAmount: isOutbound ? -txn.eventAmount : txn.eventAmount,
      originalCurrency: 'ILS',
      chargedAmount: isOutbound ? -txn.eventAmount : txn.eventAmount,
      description: txn.activityDescription || '',
      status: txn.serialNumber === 0 ? _transactions.TransactionStatuses.Pending : _transactions.TransactionStatuses.Completed,
      memo
    };
    return result;
  });
}

async function getRestContext(page) {
  await (0, _waiting.waitUntil)(async () => {
    return page.evaluate(() => !!window.bnhpApp);
  }, 'waiting for app data load');
  const result = await page.evaluate(() => {
    return window.bnhpApp.restContext;
  });
  return result.slice(1);
}

async function fetchPoalimXSRFWithinPage(page, url, pageUuid) {
  const cookies = await page.cookies();
  const XSRFCookie = cookies.find(cookie => cookie.name === 'XSRF-TOKEN');
  const headers = {};

  if (XSRFCookie != null) {
    headers['X-XSRF-TOKEN'] = XSRFCookie.value;
  }

  headers.pageUuid = pageUuid;
  headers.uuid = (0, _v.default)();
  headers['Content-Type'] = 'application/json;charset=UTF-8';
  return (0, _fetch.fetchPostWithinPage)(page, url, [], headers);
}

async function fetchAccountData(page, baseUrl, options) {
  const restContext = await getRestContext(page);
  const apiSiteUrl = `${baseUrl}/${restContext}`;
  const accountDataUrl = `${baseUrl}/ServerServices/general/accounts`;
  const accountsInfo = (await (0, _fetch.fetchGetWithinPage)(page, accountDataUrl)) || [];
  const defaultStartMoment = (0, _moment.default)().subtract(1, 'years').add(1, 'day');
  const startDate = options.startDate || defaultStartMoment.toDate();

  const startMoment = _moment.default.max(defaultStartMoment, (0, _moment.default)(startDate));

  const startDateStr = startMoment.format(DATE_FORMAT);
  const endDateStr = (0, _moment.default)().format(DATE_FORMAT);
  const accounts = [];

  for (let accountIndex = 0; accountIndex < accountsInfo.length; accountIndex += 1) {
    const accountNumber = `${accountsInfo[accountIndex].bankNumber}-${accountsInfo[accountIndex].branchNumber}-${accountsInfo[accountIndex].accountNumber}`;
    const txnsUrl = `${apiSiteUrl}/current-account/transactions?accountId=${accountNumber}&numItemsPerPage=150&retrievalEndDate=${endDateStr}&retrievalStartDate=${startDateStr}&sortCode=1`;
    const txnsResult = await fetchPoalimXSRFWithinPage(page, txnsUrl, '/current-account/transactions');
    let txns = [];

    if (txnsResult) {
      txns = convertTransactions(txnsResult.transactions);
    }

    accounts.push({
      accountNumber,
      txns
    });
  }

  const accountData = {
    success: true,
    accounts
  };
  return accountData;
}

function getPossibleLoginResults(baseUrl) {
  const urls = {};
  urls[_baseScraperWithBrowser.LoginResults.Success] = [`${baseUrl}/portalserver/HomePage`, `${baseUrl}/ng-portals-bt/rb/he/homepage`, `${baseUrl}/ng-portals/rb/he/homepage`];
  urls[_baseScraperWithBrowser.LoginResults.InvalidPassword] = [`${baseUrl}/AUTHENTICATE/LOGON?flow=AUTHENTICATE&state=LOGON&errorcode=1.6&callme=false`];
  urls[_baseScraperWithBrowser.LoginResults.ChangePassword] = [`${baseUrl}/MCP/START?flow=MCP&state=START&expiredDate=null`, /\/ABOUTTOEXPIRE\/START/i];
  return urls;
}

function createLoginFields(credentials) {
  return [{
    selector: '#userCode',
    value: credentials.userCode
  }, {
    selector: '#password',
    value: credentials.password
  }];
}

class HapoalimScraper extends _baseScraperWithBrowser.BaseScraperWithBrowser {
  // eslint-disable-next-line class-methods-use-this
  get baseUrl() {
    return 'https://login.bankhapoalim.co.il';
  }

  getLoginOptions(credentials) {
    return {
      loginUrl: `${this.baseUrl}/cgi-bin/poalwwwc?reqName=getLogonPage`,
      fields: createLoginFields(credentials),
      submitButtonSelector: '.login-btn',
      postAction: async () => (0, _navigation.waitForRedirect)(this.page),
      possibleResults: getPossibleLoginResults(this.baseUrl)
    };
  }

  async fetchData() {
    return fetchAccountData(this.page, this.baseUrl, this.options);
  }

}

var _default = HapoalimScraper;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JhcGVycy9oYXBvYWxpbS50cyJdLCJuYW1lcyI6WyJEQVRFX0ZPUk1BVCIsImNvbnZlcnRUcmFuc2FjdGlvbnMiLCJ0eG5zIiwibWFwIiwidHhuIiwiaXNPdXRib3VuZCIsImV2ZW50QWN0aXZpdHlUeXBlQ29kZSIsIm1lbW8iLCJiZW5lZmljaWFyeURldGFpbHNEYXRhIiwicGFydHlIZWFkbGluZSIsInBhcnR5TmFtZSIsIm1lc3NhZ2VIZWFkbGluZSIsIm1lc3NhZ2VEZXRhaWwiLCJtZW1vTGluZXMiLCJwdXNoIiwibGVuZ3RoIiwiam9pbiIsInJlc3VsdCIsInR5cGUiLCJUcmFuc2FjdGlvblR5cGVzIiwiTm9ybWFsIiwiaWRlbnRpZmllciIsInJlZmVyZW5jZU51bWJlciIsImRhdGUiLCJldmVudERhdGUiLCJ0b0lTT1N0cmluZyIsInByb2Nlc3NlZERhdGUiLCJ2YWx1ZURhdGUiLCJvcmlnaW5hbEFtb3VudCIsImV2ZW50QW1vdW50Iiwib3JpZ2luYWxDdXJyZW5jeSIsImNoYXJnZWRBbW91bnQiLCJkZXNjcmlwdGlvbiIsImFjdGl2aXR5RGVzY3JpcHRpb24iLCJzdGF0dXMiLCJzZXJpYWxOdW1iZXIiLCJUcmFuc2FjdGlvblN0YXR1c2VzIiwiUGVuZGluZyIsIkNvbXBsZXRlZCIsImdldFJlc3RDb250ZXh0IiwicGFnZSIsImV2YWx1YXRlIiwid2luZG93IiwiYm5ocEFwcCIsInJlc3RDb250ZXh0Iiwic2xpY2UiLCJmZXRjaFBvYWxpbVhTUkZXaXRoaW5QYWdlIiwidXJsIiwicGFnZVV1aWQiLCJjb29raWVzIiwiWFNSRkNvb2tpZSIsImZpbmQiLCJjb29raWUiLCJuYW1lIiwiaGVhZGVycyIsInZhbHVlIiwidXVpZCIsImZldGNoQWNjb3VudERhdGEiLCJiYXNlVXJsIiwib3B0aW9ucyIsImFwaVNpdGVVcmwiLCJhY2NvdW50RGF0YVVybCIsImFjY291bnRzSW5mbyIsImRlZmF1bHRTdGFydE1vbWVudCIsInN1YnRyYWN0IiwiYWRkIiwic3RhcnREYXRlIiwidG9EYXRlIiwic3RhcnRNb21lbnQiLCJtb21lbnQiLCJtYXgiLCJzdGFydERhdGVTdHIiLCJmb3JtYXQiLCJlbmREYXRlU3RyIiwiYWNjb3VudHMiLCJhY2NvdW50SW5kZXgiLCJhY2NvdW50TnVtYmVyIiwiYmFua051bWJlciIsImJyYW5jaE51bWJlciIsInR4bnNVcmwiLCJ0eG5zUmVzdWx0IiwidHJhbnNhY3Rpb25zIiwiYWNjb3VudERhdGEiLCJzdWNjZXNzIiwiZ2V0UG9zc2libGVMb2dpblJlc3VsdHMiLCJ1cmxzIiwiTG9naW5SZXN1bHRzIiwiU3VjY2VzcyIsIkludmFsaWRQYXNzd29yZCIsIkNoYW5nZVBhc3N3b3JkIiwiY3JlYXRlTG9naW5GaWVsZHMiLCJjcmVkZW50aWFscyIsInNlbGVjdG9yIiwidXNlckNvZGUiLCJwYXNzd29yZCIsIkhhcG9hbGltU2NyYXBlciIsIkJhc2VTY3JhcGVyV2l0aEJyb3dzZXIiLCJnZXRMb2dpbk9wdGlvbnMiLCJsb2dpblVybCIsImZpZWxkcyIsInN1Ym1pdEJ1dHRvblNlbGVjdG9yIiwicG9zdEFjdGlvbiIsInBvc3NpYmxlUmVzdWx0cyIsImZldGNoRGF0YSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFLQSxNQUFNQSxXQUFXLEdBQUcsVUFBcEIsQyxDQUVBOztBQWdDQSxTQUFTQyxtQkFBVCxDQUE2QkMsSUFBN0IsRUFBd0U7QUFDdEUsU0FBT0EsSUFBSSxDQUFDQyxHQUFMLENBQVVDLEdBQUQsSUFBUztBQUN2QixVQUFNQyxVQUFVLEdBQUdELEdBQUcsQ0FBQ0UscUJBQUosS0FBOEIsQ0FBakQ7QUFFQSxRQUFJQyxJQUFJLEdBQUcsRUFBWDs7QUFDQSxRQUFJSCxHQUFHLENBQUNJLHNCQUFSLEVBQWdDO0FBQzlCLFlBQU07QUFDSkMsUUFBQUEsYUFESTtBQUVKQyxRQUFBQSxTQUZJO0FBR0pDLFFBQUFBLGVBSEk7QUFJSkMsUUFB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IGZyb20gJ3V1aWQvdjQnO1xuXG5pbXBvcnQgeyBQYWdlIH0gZnJvbSAncHVwcGV0ZWVyJztcbmltcG9ydCB7IEJhc2VTY3JhcGVyV2l0aEJyb3dzZXIsIExvZ2luUmVzdWx0cywgUG9zc2libGVMb2dpblJlc3VsdHMgfSBmcm9tICcuL2Jhc2Utc2NyYXBlci13aXRoLWJyb3dzZXInO1xuaW1wb3J0IHsgd2FpdEZvclJlZGlyZWN0IH0gZnJvbSAnLi4vaGVscGVycy9uYXZpZ2F0aW9uJztcbmltcG9ydCB7IHdhaXRVbnRpbCB9IGZyb20gJy4uL2hlbHBlcnMvd2FpdGluZyc7XG5pbXBvcnQgeyBmZXRjaEdldFdpdGhpblBhZ2UsIGZldGNoUG9zdFdpdGhpblBhZ2UgfSBmcm9tICcuLi9oZWxwZXJzL2ZldGNoJztcbmltcG9ydCB7XG4gIFRyYW5zYWN0aW9uc0FjY291bnQsIFRyYW5zYWN0aW9uLCBUcmFuc2FjdGlvblN0YXR1c2VzLCBUcmFuc2FjdGlvblR5cGVzLFxufSBmcm9tICcuLi90cmFuc2FjdGlvbnMnO1xuaW1wb3J0IHsgU2NhcGVyT3B0aW9ucywgU2NyYXBlckNyZWRlbnRpYWxzIH0gZnJvbSAnLi9iYXNlLXNjcmFwZXInO1xuXG5jb25zdCBEQVRFX0ZPUk1BVCA9ICdZWVlZTU1ERCc7XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbmFtZXNwYWNlXG5kZWNsYXJlIG5hbWVzcGFjZSB3aW5kb3cge1xuICBjb25zdCBibmhwQXBwOiBhbnk7XG59XG5cbmludGVyZmFjZSBTY3JhcGVkVHJhbnNhY3Rpb24ge1xuICBzZXJpYWxOdW1iZXI/OiBudW1iZXI7XG4gIGFjdGl2aXR5RGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gIGV2ZW50QW1vdW50OiBudW1iZXI7XG4gIHZhbHVlRGF0ZT86IHN0cmluZztcbiAgZXZlbnREYXRlPzogc3RyaW5nO1xuICByZWZlcmVuY2VOdW1iZXI/OiBudW1iZXI7XG4gIFNjcmFwZWRUcmFuc2FjdGlvbj86IHN0cmluZztcbiAgZXZlbnRBY3Rpdml0eVR5cGVDb2RlOiBudW1iZXI7XG4gIGJlbmVmaWNpYXJ5RGV0YWlsc0RhdGE/OiB7XG4gICAgcGFydHlIZWFkbGluZT86IHN0cmluZztcbiAgICBwYXJ0eU5hbWU/OiBzdHJpbmc7XG4gICAgbWVzc2FnZUhlYWRsaW5lPzogc3RyaW5nO1xuICAgIG1lc3NhZ2VEZXRhaWw/OiBzdHJpbmc7XG4gIH07XG59XG5cbnR5cGUgRmV0Y2hlZEFjY291bnREYXRhID0ge1xuICBiYW5rTnVtYmVyOiBzdHJpbmc7XG4gIGFjY291bnROdW1iZXI6IHN0cmluZztcbiAgYnJhbmNoTnVtYmVyOiBzdHJpbmc7XG59W107XG5cbnR5cGUgRmV0Y2hlZEFjY291bnRUcmFuc2FjdGlvbnNEYXRhID0ge1xuICB0cmFuc2FjdGlvbnM6IFNjcmFwZWRUcmFuc2FjdGlvbltdO1xufTtcblxuZnVuY3Rpb24gY29udmVydFRyYW5zYWN0aW9ucyh0eG5zOiBTY3JhcGVkVHJhbnNhY3Rpb25bXSk6IFRyYW5zYWN0aW9uW10ge1xuICByZXR1cm4gdHhucy5tYXAoKHR4bikgPT4ge1xuICAgIGNvbnN0IGlzT3V0Ym91bmQgPSB0eG4uZXZlbnRBY3Rpdml0eVR5cGVDb2RlID09PSAyO1xuXG4gICAgbGV0IG1lbW8gPSAnJztcbiAgICBpZiAodHhuLmJlbmVmaWNpYXJ5RGV0YWlsc0RhdGEpIHtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgcGFydHlIZWFkbGluZSxcbiAgICAgICAgcGFydHlOYW1lLFxuICAgICAgICBtZXNzYWdlSGVhZGxpbmUsXG4gICAgICAgIG1lc3NhZ2VEZXRhaWwsXG4gICAgICB9ID0gdHhuLmJlbmVmaWNpYXJ5RGV0YWlsc0RhdGE7XG4gICAgICBjb25zdCBtZW1vTGluZXM6IHN0cmluZ1tdID0gW107XG4gICAgICBpZiAocGFydHlIZWFkbGluZSkge1xuICAgICAgICBtZW1vTGluZXMucHVzaChwYXJ0eUhlYWRsaW5lKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHBhcnR5TmFtZSkge1xuICAgICAgICBtZW1vTGluZXMucHVzaChgJHtwYXJ0eU5hbWV9LmApO1xuICAgICAgfVxuXG4gICAgICBpZiAobWVzc2FnZUhlYWRsaW5lKSB7XG4gICAgICAgIG1lbW9MaW5lcy5wdXNoKG1lc3NhZ2VIZWFkbGluZSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChtZXNzYWdlRGV0YWlsKSB7XG4gICAgICAgIG1lbW9MaW5lcy5wdXNoKGAke21lc3NhZ2VEZXRhaWx9LmApO1xuICAgICAgfVxuXG4gICAgICBpZiAobWVtb0xpbmVzLmxlbmd0aCkge1xuICAgICAgICBtZW1vID0gbWVtb0xpbmVzLmpvaW4oJyAnKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCByZXN1bHQ6IFRyYW5zYWN0aW9uID0ge1xuICAgICAgdHlwZTogVHJhbnNhY3Rpb25UeXBlcy5Ob3JtYWwsXG4gICAgICBpZGVudGlmaWVyOiB0eG4ucmVmZXJlbmNlTnVtYmVyLFxuICAgICAgZGF0ZTogbW9tZW50KHR4bi5ldmVudERhdGUsIERBVEVfRk9STUFUKS50b0lTT1N0cmluZygpLFxuICAgICAgcHJvY2Vzc2VkRGF0ZTogbW9tZW50KHR4bi52YWx1ZURhdGUsIERBVEVfRk9STUFUKS50b0lTT1N0cmluZygpLFxuICAgICAgb3JpZ2luYWxBbW91bnQ6IGlzT3V0Ym91bmQgPyAtdHhuLmV2ZW50QW1vdW50IDogdHhuLmV2ZW50QW1vdW50LFxuICAgICAgb3JpZ2luYWxDdXJyZW5jeTogJ0lMUycsXG4gICAgICBjaGFyZ2VkQW1vdW50OiBpc091dGJvdW5kID8gLXR4bi5ldmVudEFtb3VudCA6IHR4bi5ldmVudEFtb3VudCxcbiAgICAgIGRlc2NyaXB0aW9uOiB0eG4uYWN0aXZpdHlEZXNjcmlwdGlvbiB8fCAnJyxcbiAgICAgIHN0YXR1czogdHhuLnNlcmlhbE51bWJlciA9PT0gMCA/IFRyYW5zYWN0aW9uU3RhdHVzZXMuUGVuZGluZyA6IFRyYW5zYWN0aW9uU3RhdHVzZXMuQ29tcGxldGVkLFxuICAgICAgbWVtbyxcbiAgICB9O1xuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFJlc3RDb250ZXh0KHBhZ2U6IFBhZ2UpIHtcbiAgYXdhaXQgd2FpdFVudGlsKGFzeW5jICgpID0+IHtcbiAgICByZXR1cm4gcGFnZS5ldmFsdWF0ZSgoKSA9PiAhIXdpbmRvdy5ibmhwQXBwKTtcbiAgfSwgJ3dhaXRpbmcgZm9yIGFwcCBkYXRhIGxvYWQnKTtcblxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBwYWdlLmV2YWx1YXRlKCgpID0+IHtcbiAgICByZXR1cm4gd2luZG93LmJuaHBBcHAucmVzdENvbnRleHQ7XG4gIH0pO1xuXG4gIHJldHVybiByZXN1bHQuc2xpY2UoMSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZldGNoUG9hbGltWFNSRldpdGhpblBhZ2UocGFnZTogUGFnZSwgdXJsOiBzdHJpbmcsIHBhZ2VVdWlkOiBzdHJpbmcpOiBQcm9taXNlPEZldGNoZWRBY2NvdW50VHJhbnNhY3Rpb25zRGF0YSB8IG51bGw+IHtcbiAgY29uc3QgY29va2llcyA9IGF3YWl0IHBhZ2UuY29va2llcygpO1xuICBjb25zdCBYU1JGQ29va2llID0gY29va2llcy5maW5kKChjb29raWUpID0+IGNvb2tpZS5uYW1lID09PSAnWFNSRi1UT0tFTicpO1xuICBjb25zdCBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG4gIGlmIChYU1JGQ29va2llICE9IG51bGwpIHtcbiAgICBoZWFkZXJzWydYLVhTUkYtVE9LRU4nXSA9IFhTUkZDb29raWUudmFsdWU7XG4gIH1cbiAgaGVhZGVycy5wYWdlVXVpZCA9IHBhZ2VVdWlkO1xuICBoZWFkZXJzLnV1aWQgPSB1dWlkNCgpO1xuICBoZWFkZXJzWydDb250ZW50LVR5cGUnXSA9ICdhcHBsaWNhdGlvbi9qc29uO2NoYXJzZXQ9VVRGLTgnO1xuICByZXR1cm4gZmV0Y2hQb3N0V2l0aGluUGFnZTxGZXRjaGVkQWNjb3VudFRyYW5zYWN0aW9uc0RhdGE+KHBhZ2UsIHVybCwgW10sIGhlYWRlcnMpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmZXRjaEFjY291bnREYXRhKHBhZ2U6IFBhZ2UsIGJhc2VVcmw6IHN0cmluZywgb3B0aW9uczogU2NhcGVyT3B0aW9ucykge1xuICBjb25zdCByZXN0Q29udGV4dCA9IGF3YWl0IGdldFJlc3RDb250ZXh0KHBhZ2UpO1xuICBjb25zdCBhcGlTaXRlVXJsID0gYCR7YmFzZVVybH0vJHtyZXN0Q29udGV4dH1gO1xuICBjb25zdCBhY2NvdW50RGF0YVVybCA9IGAke2Jhc2VVcmx9L1NlcnZlclNlcnZpY2VzL2dlbmVyYWwvYWNjb3VudHNgO1xuICBjb25zdCBhY2NvdW50c0luZm8gPSBhd2FpdCBmZXRjaEdldFdpdGhpblBhZ2U8RmV0Y2hlZEFjY291bnREYXRhPihwYWdlLCBhY2NvdW50RGF0YVVybCkgfHwgW107XG5cbiAgY29uc3QgZGVmYXVsdFN0YXJ0TW9tZW50ID0gbW9tZW50KCkuc3VidHJhY3QoMSwgJ3llYXJzJykuYWRkKDEsICdkYXknKTtcbiAgY29uc3Qgc3RhcnREYXRlID0gb3B0aW9ucy5zdGFydERhdGUgfHwgZGVmYXVsdFN0YXJ0TW9tZW50LnRvRGF0ZSgpO1xuICBjb25zdCBzdGFydE1vbWVudCA9IG1vbWVudC5tYXgoZGVmYXVsdFN0YXJ0TW9tZW50LCBtb21lbnQoc3RhcnREYXRlKSk7XG5cbiAgY29uc3Qgc3RhcnREYXRlU3RyID0gc3RhcnRNb21lbnQuZm9ybWF0KERBVEVfRk9STUFUKTtcbiAgY29uc3QgZW5kRGF0ZVN0ciA9IG1vbWVudCgpLmZvcm1hdChEQVRFX0ZPUk1BVCk7XG5cbiAgY29uc3QgYWNjb3VudHM6IFRyYW5zYWN0aW9uc0FjY291bnRbXSA9IFtdO1xuICBmb3IgKGxldCBhY2NvdW50SW5kZXggPSAwOyBhY2NvdW50SW5kZXggPCBhY2NvdW50c0luZm8ubGVuZ3RoOyBhY2NvdW50SW5kZXggKz0gMSkge1xuICAgIGNvbnN0IGFjY291bnROdW1iZXIgPSBgJHthY2NvdW50c0luZm9bYWNjb3VudEluZGV4XS5iYW5rTnVtYmVyfS0ke2FjY291bnRzSW5mb1thY2NvdW50SW5kZXhdLmJyYW5jaE51bWJlcn0tJHthY2NvdW50c0luZm9bYWNjb3VudEluZGV4XS5hY2NvdW50TnVtYmVyfWA7XG5cbiAgICBjb25zdCB0eG5zVXJsID0gYCR7YXBpU2l0ZVVybH0vY3VycmVudC1hY2NvdW50L3RyYW5zYWN0aW9ucz9hY2NvdW50SWQ9JHthY2NvdW50TnVtYmVyfSZudW1JdGVtc1BlclBhZ2U9MTUwJnJldHJpZXZhbEVuZERhdGU9JHtlbmREYXRlU3RyfSZyZXRyaWV2YWxTdGFydERhdGU9JHtzdGFydERhdGVTdHJ9JnNvcnRDb2RlPTFgO1xuXG4gICAgY29uc3QgdHhuc1Jlc3VsdCA9IGF3YWl0IGZldGNoUG9hbGltWFNSRldpdGhpblBhZ2UocGFnZSwgdHhuc1VybCwgJy9jdXJyZW50LWFjY291bnQvdHJhbnNhY3Rpb25zJyk7XG4gICAgbGV0IHR4bnM6IFRyYW5zYWN0aW9uW10gPSBbXTtcbiAgICBpZiAodHhuc1Jlc3VsdCkge1xuICAgICAgdHhucyA9IGNvbnZlcnRUcmFuc2FjdGlvbnModHhuc1Jlc3VsdC50cmFuc2FjdGlvbnMpO1xuICAgIH1cblxuICAgIGFjY291bnRzLnB1c2goe1xuICAgICAgYWNjb3VudE51bWJlcixcbiAgICAgIHR4bnMsXG4gICAgfSk7XG4gIH1cblxuICBjb25zdCBhY2NvdW50RGF0YSA9IHtcbiAgICBzdWNjZXNzOiB0cnVlLFxuICAgIGFjY291bnRzLFxuICB9O1xuXG4gIHJldHVybiBhY2NvdW50RGF0YTtcbn1cblxuZnVuY3Rpb24gZ2V0UG9zc2libGVMb2dpblJlc3VsdHMoYmFzZVVybDogc3RyaW5nKSB7XG4gIGNvbnN0IHVybHM6IFBvc3NpYmxlTG9naW5SZXN1bHRzID0ge307XG4gIHVybHNbTG9naW5SZXN1bHRzLlN1Y2Nlc3NdID0gW1xuICAgIGAke2Jhc2VVcmx9L3BvcnRhbHNlcnZlci9Ib21lUGFnZWAsXG4gICAgYCR7YmFzZVVybH0vbmctcG9ydGFscy1idC9yYi9oZS9ob21lcGFnZWAsXG4gICAgYCR7YmFzZVVybH0vbmctcG9ydGFscy9yYi9oZS9ob21lcGFnZWBdO1xuICB1cmxzW0xvZ2luUmVzdWx0cy5JbnZhbGlkUGFzc3dvcmRdID0gW2Ake2Jhc2VVcmx9L0FVVEhFTlRJQ0FURS9MT0dPTj9mbG93PUFVVEhFTlRJQ0FURSZzdGF0ZT1MT0dPTiZlcnJvcmNvZGU9MS42JmNhbGxtZT1mYWxzZWBdO1xuICB1cmxzW0xvZ2luUmVzdWx0cy5DaGFuZ2VQYXNzd29yZF0gPSBbXG4gICAgYCR7YmFzZVVybH0vTUNQL1NUQVJUP2Zsb3c9TUNQJnN0YXRlPVNUQVJUJmV4cGlyZWREYXRlPW51bGxgLFxuICAgIC9cXC9BQk9VVFRPRVhQSVJFXFwvU1RBUlQvaSxcbiAgXTtcbiAgcmV0dXJuIHVybHM7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUxvZ2luRmllbGRzKGNyZWRlbnRpYWxzOiBTY3JhcGVyQ3JlZGVudGlhbHMpIHtcbiAgcmV0dXJuIFtcbiAgICB7IHNlbGVjdG9yOiAnI3VzZXJDb2RlJywgdmFsdWU6IGNyZWRlbnRpYWxzLnVzZXJDb2RlIH0sXG4gICAgeyBzZWxlY3RvcjogJyNwYXNzd29yZCcsIHZhbHVlOiBjcmVkZW50aWFscy5wYXNzd29yZCB9LFxuICBdO1xufVxuXG5jbGFzcyBIYXBvYWxpbVNjcmFwZXIgZXh0ZW5kcyBCYXNlU2NyYXBlcldpdGhCcm93c2VyIHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNsYXNzLW1ldGhvZHMtdXNlLXRoaXNcbiAgZ2V0IGJhc2VVcmwoKSB7XG4gICAgcmV0dXJuICdodHRwczovL2xvZ2luLmJhbmtoYXBvYWxpbS5jby5pbCc7XG4gIH1cblxuICBnZXRMb2dpbk9wdGlvbnMoY3JlZGVudGlhbHM6IFNjcmFwZXJDcmVkZW50aWFscykge1xuICAgIHJldHVybiB7XG4gICAgICBsb2dpblVybDogYCR7dGhpcy5iYXNlVXJsfS9jZ2ktYmluL3BvYWx3d3djP3JlcU5hbWU9Z2V0TG9nb25QYWdlYCxcbiAgICAgIGZpZWxkczogY3JlYXRlTG9naW5GaWVsZHMoY3JlZGVudGlhbHMpLFxuICAgICAgc3VibWl0QnV0dG9uU2VsZWN0b3I6ICcubG9naW4tYnRuJyxcbiAgICAgIHBvc3RBY3Rpb246IGFzeW5jICgpID0+IHdhaXRGb3JSZWRpcmVjdCh0aGlzLnBhZ2UpLFxuICAgICAgcG9zc2libGVSZXN1bHRzOiBnZXRQb3NzaWJsZUxvZ2luUmVzdWx0cyh0aGlzLmJhc2VVcmwpLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBmZXRjaERhdGEoKSB7XG4gICAgcmV0dXJuIGZldGNoQWNjb3VudERhdGEodGhpcy5wYWdlLCB0aGlzLmJhc2VVcmwsIHRoaXMub3B0aW9ucyk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgSGFwb2FsaW1TY3JhcGVyO1xuIl19