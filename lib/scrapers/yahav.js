"use strict";

require("core-js/modules/es.symbol.description");

require("core-js/modules/es.array.iterator");

require("core-js/modules/es.promise");

require("core-js/modules/es.string.replace");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _moment = _interopRequireDefault(require("moment"));

var _constants = require("../constants");

var _elementsInteractions = require("../helpers/elements-interactions");

var _navigation = require("../helpers/navigation");

var _transactions = require("../transactions");

var _baseScraperWithBrowser = require("./base-scraper-with-browser");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const LOGIN_URL = 'https://login.yahav.co.il/login/';
const BASE_URL = 'https://digital.yahav.co.il/BaNCSDigitalUI/app/index.html#/';
const INVALID_DETAILS_SELECTOR = '.ui-dialog-buttons';
const CHANGE_PASSWORD_OLD_PASS = 'input#ef_req_parameter_old_passwd';
const BASE_WELCOME_URL = `${BASE_URL}main/home`;
const ACCOUNT_ID_SELECTOR = '.dropdown-dir .selected-item-top';
const ACCOUNT_DETAILS_SELECTOR = '.account-details';
const DATE_FORMAT = 'DD/MM/YYYY';
const USER_ELEM = '#USER';
const PASSWD_ELEM = '#PASSWORD';
const NATIONALID_ELEM = '#NATIONAL_ID';

function getPossibleLoginResults(page) {
  // checkout file `base-scraper-with-browser.ts` for available result types
  const urls = {};
  urls[_baseScraperWithBrowser.LoginResults.Success] = [`${BASE_WELCOME_URL}`];
  urls[_baseScraperWithBrowser.LoginResults.InvalidPassword] = [async () => {
    return (0, _elementsInteractions.elementPresentOnPage)(page, `${INVALID_DETAILS_SELECTOR}`);
  }];
  urls[_baseScraperWithBrowser.LoginResults.ChangePassword] = [async () => {
    return (0, _elementsInteractions.elementPresentOnPage)(page, `${CHANGE_PASSWORD_OLD_PASS}`);
  }];
  return urls;
}

async function getAccountID(page) {
  const selectedSnifAccount = await page.$eval(`${ACCOUNT_ID_SELECTOR}`, option => {
    return option.innerText;
  });
  return selectedSnifAccount;
}

function getAmountData(amountStr) {
  const amountStrCopy = amountStr.replace(',', '');
  return parseFloat(amountStrCopy);
}

function getTxnAmount(txn) {
  const credit = getAmountData(txn.credit);
  const debit = getAmountData(txn.debit);
  return (Number.isNaN(credit) ? 0 : credit) - (Number.isNaN(debit) ? 0 : debit);
}

function convertTransactions(txns) {
  return txns.map(txn => {
    const convertedDate = (0, _moment.default)(txn.date, DATE_FORMAT).toISOString();
    const convertedAmount = getTxnAmount(txn);
    return {
      type: _transactions.TransactionTypes.Normal,
      identifier: txn.reference ? parseInt(txn.reference, 10) : undefined,
      date: convertedDate,
      processedDate: convertedDate,
      originalAmount: convertedAmount,
      originalCurrency: _constants.SHEKEL_CURRENCY,
      chargedAmount: convertedAmount,
      status: txn.status,
      description: txn.description,
      memo: txn.memo
    };
  });
}

function handleTransactionRow(txns, txnRow) {
  const div = txnRow.innerDivs; // Remove anything except digits.

  const regex = /\D+/gm;
  const tx = {
    date: div[1],
    reference: div[2].replace(regex, ''),
    memo: '',
    description: div[3],
    debit: div[4],
    credit: div[5],
    status: _transactions.TransactionStatuses.Completed
  };
  txns.push(tx);
} // async function sleep(ms: number) {
//   await new Promise((resolve) => setTimeout(resolve, ms));
// }


async function getAccountTransactions(page) {
  // Wait for transactions.
  await (0, _elementsInteractions.waitUntilElementFound)(page, '.under-line-txn-table-header', true);
  const txns = [];
  const transactionsDivs = await (0, _elementsInteractions.pageEvalAll)(page, '.list-item-holder .entire-content-ctr', [], divs => {
    return divs.map(div => ({
      id: div.getAttribute('id') || '',
      innerDivs: Array.from(div.getElementsByTagName('div')).map(div => div.innerText)
    }));
  });

  for (const txnRow of transactionsDivs) {
    handleTransactionRow(txns, txnRow);
  }

  return convertTransactions(txns);
}

async function searchByDates(page, startDate) {
  // Get the day number from startDate. 1-31 (usually 1)
  const startDateDay = parseInt(startDate.format('D'), 0);
  const startDateMonth = parseInt(startDate.format('M'), 0);
  const startDateYear = startDate.format('Y'); // Open the calendar date picker

  const dateFromPick = 'div.date-options-cell:nth-child(7) > date-picker:nth-child(1) > div:nth-child(1) > span:nth-child(2)';
  await (0, _elementsInteractions.waitUntilElementFound)(page, dateFromPick, true);
  await (0, _elementsInteractions.clickButton)(page, dateFromPick); // Wait until first day appear.

  await (0, _elementsInteractions.waitUntilElementFound)(page, '.pmu-days > div:nth-child(1)', true); // Open Months options.
  // await sleep(500);

  const monthFromPick = '.pmu-month';
  await (0, _elementsInteractions.waitUntilElementFound)(page, monthFromPick, true);
  await (0, _elementsInteractions.clickButton)(page, monthFromPick); // await page.click(monthFromPick);

  await (0, _elementsInteractions.waitUntilElementFound)(page, '.pmu-months > div:nth-child(1)', true); // Open Year options.
  // await sleep(500);
  // Use same selector... Yahav knows why...

  await (0, _elementsInteractions.waitUntilElementFound)(page, monthFromPick, true);
  await (0, _elementsInteractions.clickButton)(page, monthFromPick); // await page.click(monthFromPick);

  await (0, _elementsInteractions.waitUntilElementFound)(page, '.pmu-years > div:nth-child(1)', true); // Select year.

  for (let i = 1; i < 13; i += 1) {
    const selector = `.pmu-years > div:nth-child(${i})`;
    const year = await page.$eval(selector, y => {
      return y.innerText;
    });

    if (startDateYear === year) {
      await (0, _elementsInteractions.clickButton)(page, selector); // await page.click(selector);

      break;
    }
  } // Select Month.


  await (0, _elementsInteractions.waitUntilElementFound)(page, '.pmu-months > div:nth-child(1)', true);
  const monthSelector = `.pmu-months > div:nth-child(${startDateMonth})`;
  await (0, _elementsInteractions.clickButton)(page, monthSelector); // await page.click(monthSelector);
  // Select Day.
  // The calendar grid shows 7 days and 6 weeks = 42 days

  for (let i = 1; i < 42; i += 1) {
    const selector = `.pmu-days > div:nth-child(${i})`;
    const day = await page.$eval(selector, d => {
      return d.innerText;
    });

    if (startDateDay === parseInt(day, 0)) {
      await (0, _elementsInteractions.clickButton)(page, selector); // await page.click(selector);

      break;
    }
  }
} // function filterTXByDate(txns: Transaction[], startDate: Moment): Transaction[] {
//   const txs = _.filter(txns, (tx) => {
//     return startDate.isSameOrBefore(tx.date, 'day');
//   });
//   return txs;
// }


async function fetchAccountData(page, startDate, accountID) {
  await (0, _elementsInteractions.waitUntilElementDisappear)(page, '.loading-bar-spinner');
  await searchByDates(page, startDate);
  await (0, _elementsInteractions.waitUntilElementDisappear)(page, '.loading-bar-spinner');
  const accountTxs = await getAccountTransactions(page); // Filter tx by date because searchbydates do not work.
  // const txns = filterTXByDate(accountTxs, startDate);

  return {
    accountNumber: accountID,
    txns: accountTxs
  };
}

async function fetchAccounts(page, startDate) {
  const accounts = []; // TODO: get more accounts

  const accountID = await getAccountID(page);
  const accountData = await fetchAccountData(page, startDate, accountID);
  accounts.push(accountData);
  return accounts;
}

async function waitReadinessForAll(page) {
  await (0, _elementsInteractions.waitUntilElementFound)(page, `${USER_ELEM}`, true);
  await (0, _elementsInteractions.waitUntilElementFound)(page, `${PASSWD_ELEM}`, true);
  await (0, _elementsInteractions.waitUntilElementFound)(page, `${NATIONALID_ELEM}`, true);
}

async function redirectOrDialog(page) {
  // Click on messages
  await (0, _navigation.waitForNavigation)(page);
  await (0, _elementsInteractions.waitUntilElementDisappear)(page, '.loading-bar-spinner');
  const hasMessage = await (0, _elementsInteractions.elementPresentOnPage)(page, '.messaging-links-container');

  if (hasMessage) {
    await (0, _elementsInteractions.clickButton)(page, '.link-1');
  }

  const promise1 = page.waitForSelector(ACCOUNT_DETAILS_SELECTOR, {
    timeout: 30000
  });
  const promise2 = page.waitForSelector(CHANGE_PASSWORD_OLD_PASS, {
    timeout: 30000
  });
  const promises = [promise1, promise2];
  await Promise.race(promises);
  await (0, _elementsInteractions.waitUntilElementDisappear)(page, '.loading-bar-spinner');
}

class YahavScraper extends _baseScraperWithBrowser.BaseScraperWithBrowser {
  getLoginOptions(credentials) {
    return {
      loginUrl: `${LOGIN_URL}`,
      fields: [{
        selector: `${USER_ELEM}`,
        value: credentials.username
      }, {
        selector: `${PASSWD_ELEM}`,
        value: credentials.password
      }, {
        selector: `${NATIONALID_ELEM}`,
        value: credentials.nationalID
      }],
      submitButtonSelector: '.submit',
      checkReadiness: async () => waitReadinessForAll(this.page),
      postAction: async () => redirectOrDialog(this.page),
      possibleResults: getPossibleLoginResults(this.page)
    };
  }

  async fetchData() {
    // Goto statements page
    await (0, _elementsInteractions.waitUntilElementFound)(this.page, ACCOUNT_DETAILS_SELECTOR, true);
    await (0, _elementsInteractions.clickButton)(this.page, ACCOUNT_DETAILS_SELECTOR);
    await (0, _elementsInteractions.waitUntilElementFound)(this.page, '.statement-options .selected-item-top', true);
    const defaultStartMoment = (0, _moment.default)().subtract(3, 'months').add(1, 'day');
    const startDate = this.options.startDate || defaultStartMoment.toDate();

    const startMoment = _moment.default.max(defaultStartMoment, (0, _moment.default)(startDate));

    const accounts = await fetchAccounts(this.page, startMoment);
    return {
      success: true,
      accounts
    };
  }

}

var _default = YahavScraper;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JhcGVycy95YWhhdi50cyJdLCJuYW1lcyI6WyJMT0dJTl9VUkwiLCJCQVNFX1VSTCIsIklOVkFMSURfREVUQUlMU19TRUxFQ1RPUiIsIkNIQU5HRV9QQVNTV09SRF9PTERfUEFTUyIsIkJBU0VfV0VMQ09NRV9VUkwiLCJBQ0NPVU5UX0lEX1NFTEVDVE9SIiwiQUNDT1VOVF9ERVRBSUxTX1NFTEVDVE9SIiwiREFURV9GT1JNQVQiLCJVU0VSX0VMRU0iLCJQQVNTV0RfRUxFTSIsIk5BVElPTkFMSURfRUxFTSIsImdldFBvc3NpYmxlTG9naW5SZXN1bHRzIiwicGFnZSIsInVybHMiLCJMb2dpblJlc3VsdHMiLCJTdWNjZXNzIiwiSW52YWxpZFBhc3N3b3JkIiwiQ2hhbmdlUGFzc3dvcmQiLCJnZXRBY2NvdW50SUQiLCJzZWxlY3RlZFNuaWZBY2NvdW50IiwiJGV2YWwiLCJvcHRpb24iLCJpbm5lclRleHQiLCJnZXRBbW91bnREYXRhIiwiYW1vdW50U3RyIiwiYW1vdW50U3RyQ29weSIsInJlcGxhY2UiLCJwYXJzZUZsb2F0IiwiZ2V0VHhuQW1vdW50IiwidHhuIiwiY3JlZGl0IiwiZGViaXQiLCJOdW1iZXIiLCJpc05hTiIsImNvbnZlcnRUcmFuc2FjdGlvbnMiLCJ0eG5zIiwibWFwIiwiY29udmVydGVkRGF0ZSIsImRhdGUiLCJ0b0lTT1N0cmluZyIsImNvbnZlcnRlZEFtb3VudCIsInR5cGUiLCJUcmFuc2FjdGlvblR5cGVzIiwiTm9ybWFsIiwiaWRlbnRpZmllciIsInJlZmVyZW5jZSIsInBhcnNlSW50IiwidW5kZWZpbmVkIiwicHJvY2Vzc2VkRGF0ZSIsIm9yaWdpbmFsQW1vdW50Iiwib3JpZ2luYWxDdXJyZW5jeSIsIlNIRUtFTF9DVVJSRU5DWSIsImNoYXJnZWRBbW91bnQiLCJzdGF0dXMiLCJkZXNjcmlwdGlvbiIsIm1lbW8iLCJoYW5kbGVUcmFuc2FjdGlvblJvdyIsInR4blJvdyIsImRpdiIsImlubmVyRGl2cyIsInJlZ2V4IiwidHgiLCJUcmFuc2FjdGlvblN0YXR1c2VzIiwiQ29tcGxldGVkIiwicHVzaCIsImdldEFjY291bnRUcmFuc2FjdGlvbnMiLCJ0cmFuc2FjdGlvbnNEaXZzIiwiZGl2cyIsImlkIiwiZ2V0QXR0cmlidXRlIiwiQXJyYXkiLCJmcm9tIiwiZ2V0RWxlbWVudHNCeVRhZ05hbWUiLCJzZWFyY2hCeURhdGVzIiwic3RhcnREYXRlIiwic3RhcnREYXRlRGF5IiwiZm9ybWF0Iiwic3RhcnREYXRlTW9udGgiLCJzdGFydERhdGVZZWFyIiwiZGF0ZUZyb21QaWNrIiwibW9udGhGcm9tUGljayIsImkiLCJzZWxlY3RvciIsInllYXIiLCJ5IiwibW9udGhTZWxlY3RvciIsImRheSIsImQiLCJmZXRjaEFjY291bnREYXRhIiwiYWNjb3VudElEIiwiYWNjb3VudFR4cyIsImFjY291bnROdW1iZXIiLCJmZXRjaEFjY291bnRzIiwiYWNjb3VudHMiLCJhY2NvdW50RGF0YSIsIndhaXRSZWFkaW5lc3NGb3JBbGwiLCJyZWRpcmVjdE9yRGlhbG9nIiwiaGFzTWVzc2FnZSIsInByb21pc2UxIiwid2FpdEZvclNlbGVjdG9yIiwidGltZW91dCIsInByb21pc2UyIiwicHJvbWlzZXMiLCJQcm9taXNlIiwicmFjZSIsIllhaGF2U2NyYXBlciIsIkJhc2VTY3JhcGVyV2l0aEJyb3dzZXIiLCJnZXRMb2dpbk9wdGlvbnMiLCJjcmVkZW50aWFscyIsImxvZ2luVXJsIiwiZmllbGRzIiwidmFsdWUiLCJ1c2VybmFtZSIsInBhc3N3b3JkIiwibmF0aW9uYWxJRCIsInN1Ym1pdEJ1dHRvblNlbGVjdG9yIiwiY2hlY2tSZWFkaW5lc3MiLCJwb3N0QWN0aW9uIiwicG9zc2libGVSZXN1bHRzIiwiZmV0Y2hEYXRhIiwiZGVmYXVsdFN0YXJ0TW9tZW50Iiwic3VidHJhY3QiLCJhZGQiLCJvcHRpb25zIiwidG9EYXRlIiwic3RhcnRNb21lbnQiLCJtb21lbnQiLCJtYXgiLCJzdWNjZXNzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7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QyxJQUFOO0FBVm5DLEtBQVA7QUFZRDs7QUFFRCxRQUFNMkcsU0FBTixHQUFrQjtBQUNoQjtBQUNBLFVBQU0saURBQXNCLEtBQUszRyxJQUEzQixFQUFpQ04sd0JBQWpDLEVBQTJELElBQTNELENBQU47QUFDQSxVQUFNLHVDQUFZLEtBQUtNLElBQWpCLEVBQXVCTix3QkFBdkIsQ0FBTjtBQUNBLFVBQU0saURBQXNCLEtBQUtNLElBQTNCLEVBQWlDLHVDQUFqQyxFQUEwRSxJQUExRSxDQUFOO0FBRUEsVUFBTTRHLGtCQUFrQixHQUFHLHVCQUFTQyxRQUFULENBQWtCLENBQWxCLEVBQXFCLFFBQXJCLEVBQStCQyxHQUEvQixDQUFtQyxDQUFuQyxFQUFzQyxLQUF0QyxDQUEzQjtBQUNBLFVBQU1oRCxTQUFTLEdBQUcsS0FBS2lELE9BQUwsQ0FBYWpELFNBQWIsSUFBMEI4QyxrQkFBa0IsQ0FBQ0ksTUFBbkIsRUFBNUM7O0FBQ0EsVUFBTUMsV0FBVyxHQUFHQyxnQkFBT0MsR0FBUCxDQUFXUCxrQkFBWCxFQUErQixxQkFBTzlDLFNBQVAsQ0FBL0IsQ0FBcEI7O0FBRUEsVUFBTW1CLFFBQVEsR0FBRyxNQUFNRCxhQUFhLENBQUMsS0FBS2hGLElBQU4sRUFBWWlILFdBQVosQ0FBcEM7QUFFQSxXQUFPO0FBQ0xHLE1BQUFBLE9BQU8sRUFBRSxJQURKO0FBRUxuQyxNQUFBQTtBQUZLLEtBQVA7QUFJRDs7QUFoQytDOztlQW1DbkNZLFkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbW9tZW50LCB7IE1vbWVudCB9IGZyb20gJ21vbWVudCc7XG5pbXBvcnQgeyBQYWdlIH0gZnJvbSAncHVwcGV0ZWVyJztcbmltcG9ydCB7IFNIRUtFTF9DVVJSRU5DWSB9IGZyb20gJy4uL2NvbnN0YW50cyc7XG5pbXBvcnQge1xuICBjbGlja0J1dHRvbiwgZWxlbWVudFByZXNlbnRPblBhZ2UsXG4gIHBhZ2VFdmFsQWxsLCB3YWl0VW50aWxFbGVtZW50RGlzYXBwZWFyLCB3YWl0VW50aWxFbGVtZW50Rm91bmQsXG59IGZyb20gJy4uL2hlbHBlcnMvZWxlbWVudHMtaW50ZXJhY3Rpb25zJztcbmltcG9ydCB7IHdhaXRGb3JOYXZpZ2F0aW9uIH0gZnJvbSAnLi4vaGVscGVycy9uYXZpZ2F0aW9uJztcbmltcG9ydCB7XG4gIFRyYW5zYWN0aW9uLCBUcmFuc2FjdGlvbnNBY2NvdW50LFxuICBUcmFuc2FjdGlvblN0YXR1c2VzLCBUcmFuc2FjdGlvblR5cGVzLFxufSBmcm9tICcuLi90cmFuc2FjdGlvbnMnO1xuaW1wb3J0IHsgU2NyYXBlckNyZWRlbnRpYWxzIH0gZnJvbSAnLi9iYXNlLXNjcmFwZXInO1xuaW1wb3J0IHtcbiAgQmFzZVNjcmFwZXJXaXRoQnJvd3NlcixcbiAgTG9naW5SZXN1bHRzLFxuICBQb3NzaWJsZUxvZ2luUmVzdWx0cyxcbn0gZnJvbSAnLi9iYXNlLXNjcmFwZXItd2l0aC1icm93c2VyJztcblxuY29uc3QgTE9HSU5fVVJMID0gJ2h0dHBzOi8vbG9naW4ueWFoYXYuY28uaWwvbG9naW4vJztcbmNvbnN0IEJBU0VfVVJMID0gJ2h0dHBzOi8vZGlnaXRhbC55YWhhdi5jby5pbC9CYU5DU0RpZ2l0YWxVSS9hcHAvaW5kZXguaHRtbCMvJztcbmNvbnN0IElOVkFMSURfREVUQUlMU19TRUxFQ1RPUiA9ICcudWktZGlhbG9nLWJ1dHRvbnMnO1xuY29uc3QgQ0hBTkdFX1BBU1NXT1JEX09MRF9QQVNTID0gJ2lucHV0I2VmX3JlcV9wYXJhbWV0ZXJfb2xkX3Bhc3N3ZCc7XG5jb25zdCBCQVNFX1dFTENPTUVfVVJMID0gYCR7QkFTRV9VUkx9bWFpbi9ob21lYDtcblxuY29uc3QgQUNDT1VOVF9JRF9TRUxFQ1RPUiA9ICcuZHJvcGRvd24tZGlyIC5zZWxlY3RlZC1pdGVtLXRvcCc7XG5jb25zdCBBQ0NPVU5UX0RFVEFJTFNfU0VMRUNUT1IgPSAnLmFjY291bnQtZGV0YWlscyc7XG5jb25zdCBEQVRFX0ZPUk1BVCA9ICdERC9NTS9ZWVlZJztcblxuY29uc3QgVVNFUl9FTEVNID0gJyNVU0VSJztcbmNvbnN0IFBBU1NXRF9FTEVNID0gJyNQQVNTV09SRCc7XG5jb25zdCBOQVRJT05BTElEX0VMRU0gPSAnI05BVElPTkFMX0lEJztcblxuaW50ZXJmYWNlIFNjcmFwZWRUcmFuc2FjdGlvbiB7XG4gIGNyZWRpdDogc3RyaW5nO1xuICBkZWJpdDogc3RyaW5nO1xuICBkYXRlOiBzdHJpbmc7XG4gIHJlZmVyZW5jZT86IHN0cmluZztcbiAgZGVzY3JpcHRpb246IHN0cmluZztcbiAgbWVtbzogc3RyaW5nO1xuICBzdGF0dXM6IFRyYW5zYWN0aW9uU3RhdHVzZXM7XG59XG5cbmZ1bmN0aW9uIGdldFBvc3NpYmxlTG9naW5SZXN1bHRzKHBhZ2U6IFBhZ2UpOiBQb3NzaWJsZUxvZ2luUmVzdWx0cyB7XG4gIC8vIGNoZWNrb3V0IGZpbGUgYGJhc2Utc2NyYXBlci13aXRoLWJyb3dzZXIudHNgIGZvciBhdmFpbGFibGUgcmVzdWx0IHR5cGVzXG4gIGNvbnN0IHVybHM6IFBvc3NpYmxlTG9naW5SZXN1bHRzID0ge307XG4gIHVybHNbTG9naW5SZXN1bHRzLlN1Y2Nlc3NdID0gW1xuICAgIGAke0JBU0VfV0VMQ09NRV9VUkx9YCxcbiAgXTtcbiAgdXJsc1tMb2dpblJlc3VsdHMuSW52YWxpZFBhc3N3b3JkXSA9IFthc3luYyAoKSA9PiB7XG4gICAgcmV0dXJuIGVsZW1lbnRQcmVzZW50T25QYWdlKHBhZ2UsIGAke0lOVkFMSURfREVUQUlMU19TRUxFQ1RPUn1gKTtcbiAgfV07XG5cbiAgdXJsc1tMb2dpblJlc3VsdHMuQ2hhbmdlUGFzc3dvcmRdID0gW2FzeW5jICgpID0+IHtcbiAgICByZXR1cm4gZWxlbWVudFByZXNlbnRPblBhZ2UocGFnZSwgYCR7Q0hBTkdFX1BBU1NXT1JEX09MRF9QQVNTfWApO1xuICB9XTtcblxuICByZXR1cm4gdXJscztcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0QWNjb3VudElEKHBhZ2U6IFBhZ2UpIHtcbiAgY29uc3Qgc2VsZWN0ZWRTbmlmQWNjb3VudCA9IGF3YWl0IHBhZ2UuJGV2YWwoYCR7QUNDT1VOVF9JRF9TRUxFQ1RPUn1gLCAob3B0aW9uKSA9PiB7XG4gICAgcmV0dXJuIChvcHRpb24gYXMgSFRNTEVsZW1lbnQpLmlubmVyVGV4dDtcbiAgfSk7XG5cbiAgcmV0dXJuIHNlbGVjdGVkU25pZkFjY291bnQ7XG59XG5cbmZ1bmN0aW9uIGdldEFtb3VudERhdGEoYW1vdW50U3RyOiBzdHJpbmcpIHtcbiAgY29uc3QgYW1vdW50U3RyQ29weSA9IGFtb3VudFN0ci5yZXBsYWNlKCcsJywgJycpO1xuICByZXR1cm4gcGFyc2VGbG9hdChhbW91bnRTdHJDb3B5KTtcbn1cblxuZnVuY3Rpb24gZ2V0VHhuQW1vdW50KHR4bjogU2NyYXBlZFRyYW5zYWN0aW9uKSB7XG4gIGNvbnN0IGNyZWRpdCA9IGdldEFtb3VudERhdGEodHhuLmNyZWRpdCk7XG4gIGNvbnN0IGRlYml0ID0gZ2V0QW1vdW50RGF0YSh0eG4uZGViaXQpO1xuICByZXR1cm4gKE51bWJlci5pc05hTihjcmVkaXQpID8gMCA6IGNyZWRpdCkgLSAoTnVtYmVyLmlzTmFOKGRlYml0KSA/IDAgOiBkZWJpdCk7XG59XG5cbnR5cGUgVHJhbnNhY3Rpb25zVHIgPSB7IGlkOiBzdHJpbmcsIGlubmVyRGl2czogc3RyaW5nW10gfTtcblxuZnVuY3Rpb24gY29udmVydFRyYW5zYWN0aW9ucyh0eG5zOiBTY3JhcGVkVHJhbnNhY3Rpb25bXSk6IFRyYW5zYWN0aW9uW10ge1xuICByZXR1cm4gdHhucy5tYXAoKHR4bikgPT4ge1xuICAgIGNvbnN0IGNvbnZlcnRlZERhdGUgPSBtb21lbnQodHhuLmRhdGUsIERBVEVfRk9STUFUKS50b0lTT1N0cmluZygpO1xuICAgIGNvbnN0IGNvbnZlcnRlZEFtb3VudCA9IGdldFR4bkFtb3VudCh0eG4pO1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiBUcmFuc2FjdGlvblR5cGVzLk5vcm1hbCxcbiAgICAgIGlkZW50aWZpZXI6IHR4bi5yZWZlcmVuY2UgPyBwYXJzZUludCh0eG4ucmVmZXJlbmNlLCAxMCkgOiB1bmRlZmluZWQsXG4gICAgICBkYXRlOiBjb252ZXJ0ZWREYXRlLFxuICAgICAgcHJvY2Vzc2VkRGF0ZTogY29udmVydGVkRGF0ZSxcbiAgICAgIG9yaWdpbmFsQW1vdW50OiBjb252ZXJ0ZWRBbW91bnQsXG4gICAgICBvcmlnaW5hbEN1cnJlbmN5OiBTSEVLRUxfQ1VSUkVOQ1ksXG4gICAgICBjaGFyZ2VkQW1vdW50OiBjb252ZXJ0ZWRBbW91bnQsXG4gICAgICBzdGF0dXM6IHR4bi5zdGF0dXMsXG4gICAgICBkZXNjcmlwdGlvbjogdHhuLmRlc2NyaXB0aW9uLFxuICAgICAgbWVtbzogdHhuLm1lbW8sXG4gICAgfTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGhhbmRsZVRyYW5zYWN0aW9uUm93KHR4bnM6IFNjcmFwZWRUcmFuc2FjdGlvbltdLCB0eG5Sb3c6IFRyYW5zYWN0aW9uc1RyKSB7XG4gIGNvbnN0IGRpdiA9IHR4blJvdy5pbm5lckRpdnM7XG5cbiAgLy8gUmVtb3ZlIGFueXRoaW5nIGV4Y2VwdCBkaWdpdHMuXG4gIGNvbnN0IHJlZ2V4ID0gL1xcRCsvZ207XG5cbiAgY29uc3QgdHg6IFNjcmFwZWRUcmFuc2FjdGlvbiA9IHtcbiAgICBkYXRlOiBkaXZbMV0sXG4gICAgcmVmZXJlbmNlOiBkaXZbMl0ucmVwbGFjZShyZWdleCwgJycpLFxuICAgIG1lbW86ICcnLFxuICAgIGRlc2NyaXB0aW9uOiBkaXZbM10sXG4gICAgZGViaXQ6IGRpdls0XSxcbiAgICBjcmVkaXQ6IGRpdls1XSxcbiAgICBzdGF0dXM6IFRyYW5zYWN0aW9uU3RhdHVzZXMuQ29tcGxldGVkLFxuICB9O1xuXG4gIHR4bnMucHVzaCh0eCk7XG59XG5cbi8vIGFzeW5jIGZ1bmN0aW9uIHNsZWVwKG1zOiBudW1iZXIpIHtcbi8vICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTtcbi8vIH1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0QWNjb3VudFRyYW5zYWN0aW9ucyhwYWdlOiBQYWdlKTogUHJvbWlzZTxUcmFuc2FjdGlvbltdPiB7XG4gIC8vIFdhaXQgZm9yIHRyYW5zYWN0aW9ucy5cbiAgYXdhaXQgd2FpdFVudGlsRWxlbWVudEZvdW5kKHBhZ2UsICcudW5kZXItbGluZS10eG4tdGFibGUtaGVhZGVyJywgdHJ1ZSk7XG5cbiAgY29uc3QgdHhuczogU2NyYXBlZFRyYW5zYWN0aW9uW10gPSBbXTtcbiAgY29uc3QgdHJhbnNhY3Rpb25zRGl2cyA9IGF3YWl0IHBhZ2VFdmFsQWxsPFRyYW5zYWN0aW9uc1RyW10+KHBhZ2UsICcubGlzdC1pdGVtLWhvbGRlciAuZW50aXJlLWNvbnRlbnQtY3RyJywgW10sIChkaXZzKSA9PiB7XG4gICAgcmV0dXJuIChkaXZzIGFzIEhUTUxFbGVtZW50W10pLm1hcCgoZGl2KSA9PiAoe1xuICAgICAgaWQ6IChkaXYpLmdldEF0dHJpYnV0ZSgnaWQnKSB8fCAnJyxcbiAgICAgIGlubmVyRGl2czogQXJyYXkuZnJvbShkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2RpdicpKS5tYXAoKGRpdikgPT4gKGRpdiBhcyBIVE1MRWxlbWVudCkuaW5uZXJUZXh0KSxcbiAgICB9KSk7XG4gIH0pO1xuXG4gIGZvciAoY29uc3QgdHhuUm93IG9mIHRyYW5zYWN0aW9uc0RpdnMpIHtcbiAgICBoYW5kbGVUcmFuc2FjdGlvblJvdyh0eG5zLCB0eG5Sb3cpO1xuICB9XG5cbiAgcmV0dXJuIGNvbnZlcnRUcmFuc2FjdGlvbnModHhucyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNlYXJjaEJ5RGF0ZXMocGFnZTogUGFnZSwgc3RhcnREYXRlOiBNb21lbnQpIHtcbiAgLy8gR2V0IHRoZSBkYXkgbnVtYmVyIGZyb20gc3RhcnREYXRlLiAxLTMxICh1c3VhbGx5IDEpXG4gIGNvbnN0IHN0YXJ0RGF0ZURheSA9IHBhcnNlSW50KHN0YXJ0RGF0ZS5mb3JtYXQoJ0QnKSwgMCk7XG4gIGNvbnN0IHN0YXJ0RGF0ZU1vbnRoID0gcGFyc2VJbnQoc3RhcnREYXRlLmZvcm1hdCgnTScpLCAwKTtcbiAgY29uc3Qgc3RhcnREYXRlWWVhciA9IHN0YXJ0RGF0ZS5mb3JtYXQoJ1knKTtcblxuICAvLyBPcGVuIHRoZSBjYWxlbmRhciBkYXRlIHBpY2tlclxuICBjb25zdCBkYXRlRnJvbVBpY2sgPSAnZGl2LmRhdGUtb3B0aW9ucy1jZWxsOm50aC1jaGlsZCg3KSA+IGRhdGUtcGlja2VyOm50aC1jaGlsZCgxKSA+IGRpdjpudGgtY2hpbGQoMSkgPiBzcGFuOm50aC1jaGlsZCgyKSc7XG4gIGF3YWl0IHdhaXRVbnRpbEVsZW1lbnRGb3VuZChwYWdlLCBkYXRlRnJvbVBpY2ssIHRydWUpO1xuICBhd2FpdCBjbGlja0J1dHRvbihwYWdlLCBkYXRlRnJvbVBpY2spO1xuXG4gIC8vIFdhaXQgdW50aWwgZmlyc3QgZGF5IGFwcGVhci5cbiAgYXdhaXQgd2FpdFVudGlsRWxlbWVudEZvdW5kKHBhZ2UsICcucG11LWRheXMgPiBkaXY6bnRoLWNoaWxkKDEpJywgdHJ1ZSk7XG5cbiAgLy8gT3BlbiBNb250aHMgb3B0aW9ucy5cbiAgLy8gYXdhaXQgc2xlZXAoNTAwKTtcbiAgY29uc3QgbW9udGhGcm9tUGljayA9ICcucG11LW1vbnRoJztcbiAgYXdhaXQgd2FpdFVudGlsRWxlbWVudEZvdW5kKHBhZ2UsIG1vbnRoRnJvbVBpY2ssIHRydWUpO1xuICBhd2FpdCBjbGlja0J1dHRvbihwYWdlLCBtb250aEZyb21QaWNrKTtcbiAgLy8gYXdhaXQgcGFnZS5jbGljayhtb250aEZyb21QaWNrKTtcbiAgYXdhaXQgd2FpdFVudGlsRWxlbWVudEZvdW5kKHBhZ2UsICcucG11LW1vbnRocyA+IGRpdjpudGgtY2hpbGQoMSknLCB0cnVlKTtcblxuICAvLyBPcGVuIFllYXIgb3B0aW9ucy5cbiAgLy8gYXdhaXQgc2xlZXAoNTAwKTtcbiAgLy8gVXNlIHNhbWUgc2VsZWN0b3IuLi4gWWFoYXYga25vd3Mgd2h5Li4uXG4gIGF3YWl0IHdhaXRVbnRpbEVsZW1lbnRGb3VuZChwYWdlLCBtb250aEZyb21QaWNrLCB0cnVlKTtcbiAgYXdhaXQgY2xpY2tCdXR0b24ocGFnZSwgbW9udGhGcm9tUGljayk7XG4gIC8vIGF3YWl0IHBhZ2UuY2xpY2sobW9udGhGcm9tUGljayk7XG4gIGF3YWl0IHdhaXRVbnRpbEVsZW1lbnRGb3VuZChwYWdlLCAnLnBtdS15ZWFycyA+IGRpdjpudGgtY2hpbGQoMSknLCB0cnVlKTtcblxuICAvLyBTZWxlY3QgeWVhci5cbiAgZm9yIChsZXQgaSA9IDE7IGkgPCAxMzsgaSArPSAxKSB7XG4gICAgY29uc3Qgc2VsZWN0b3IgPSBgLnBtdS15ZWFycyA+IGRpdjpudGgtY2hpbGQoJHtpfSlgO1xuICAgIGNvbnN0IHllYXIgPSBhd2FpdCBwYWdlLiRldmFsKHNlbGVjdG9yLCAoeSkgPT4ge1xuICAgICAgcmV0dXJuICh5IGFzIEhUTUxFbGVtZW50KS5pbm5lclRleHQ7XG4gICAgfSk7XG4gICAgaWYgKHN0YXJ0RGF0ZVllYXIgPT09IHllYXIpIHtcbiAgICAgIGF3YWl0IGNsaWNrQnV0dG9uKHBhZ2UsIHNlbGVjdG9yKTtcbiAgICAgIC8vIGF3YWl0IHBhZ2UuY2xpY2soc2VsZWN0b3IpO1xuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgLy8gU2VsZWN0IE1vbnRoLlxuICBhd2FpdCB3YWl0VW50aWxFbGVtZW50Rm91bmQocGFnZSwgJy5wbXUtbW9udGhzID4gZGl2Om50aC1jaGlsZCgxKScsIHRydWUpO1xuICBjb25zdCBtb250aFNlbGVjdG9yID0gYC5wbXUtbW9udGhzID4gZGl2Om50aC1jaGlsZCgke3N0YXJ0RGF0ZU1vbnRofSlgO1xuICBhd2FpdCBjbGlja0J1dHRvbihwYWdlLCBtb250aFNlbGVjdG9yKTtcbiAgLy8gYXdhaXQgcGFnZS5jbGljayhtb250aFNlbGVjdG9yKTtcblxuICAvLyBTZWxlY3QgRGF5LlxuICAvLyBUaGUgY2FsZW5kYXIgZ3JpZCBzaG93cyA3IGRheXMgYW5kIDYgd2Vla3MgPSA0MiBkYXlzXG4gIGZvciAobGV0IGkgPSAxOyBpIDwgNDI7IGkgKz0gMSkge1xuICAgIGNvbnN0IHNlbGVjdG9yID0gYC5wbXUtZGF5cyA+IGRpdjpudGgtY2hpbGQoJHtpfSlgO1xuICAgIGNvbnN0IGRheSA9IGF3YWl0IHBhZ2UuJGV2YWwoc2VsZWN0b3IsIChkKSA9PiB7XG4gICAgICByZXR1cm4gKGQgYXMgSFRNTEVsZW1lbnQpLmlubmVyVGV4dDtcbiAgICB9KTtcblxuICAgIGlmIChzdGFydERhdGVEYXkgPT09IHBhcnNlSW50KGRheSwgMCkpIHtcbiAgICAgIGF3YWl0IGNsaWNrQnV0dG9uKHBhZ2UsIHNlbGVjdG9yKTtcbiAgICAgIC8vIGF3YWl0IHBhZ2UuY2xpY2soc2VsZWN0b3IpO1xuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG59XG5cbi8vIGZ1bmN0aW9uIGZpbHRlclRYQnlEYXRlKHR4bnM6IFRyYW5zYWN0aW9uW10sIHN0YXJ0RGF0ZTogTW9tZW50KTogVHJhbnNhY3Rpb25bXSB7XG4vLyAgIGNvbnN0IHR4cyA9IF8uZmlsdGVyKHR4bnMsICh0eCkgPT4ge1xuLy8gICAgIHJldHVybiBzdGFydERhdGUuaXNTYW1lT3JCZWZvcmUodHguZGF0ZSwgJ2RheScpO1xuLy8gICB9KTtcblxuLy8gICByZXR1cm4gdHhzO1xuLy8gfVxuXG5hc3luYyBmdW5jdGlvbiBmZXRjaEFjY291bnREYXRhKHBhZ2U6IFBhZ2UsIHN0YXJ0RGF0ZTogTW9tZW50LCBhY2NvdW50SUQ6IHN0cmluZyk6IFByb21pc2U8VHJhbnNhY3Rpb25zQWNjb3VudD4ge1xuICBhd2FpdCB3YWl0VW50aWxFbGVtZW50RGlzYXBwZWFyKHBhZ2UsICcubG9hZGluZy1iYXItc3Bpbm5lcicpO1xuICBhd2FpdCBzZWFyY2hCeURhdGVzKHBhZ2UsIHN0YXJ0RGF0ZSk7XG4gIGF3YWl0IHdhaXRVbnRpbEVsZW1lbnREaXNhcHBlYXIocGFnZSwgJy5sb2FkaW5nLWJhci1zcGlubmVyJyk7XG4gIGNvbnN0IGFjY291bnRUeHMgPSBhd2FpdCBnZXRBY2NvdW50VHJhbnNhY3Rpb25zKHBhZ2UpO1xuICAvLyBGaWx0ZXIgdHggYnkgZGF0ZSBiZWNhdXNlIHNlYXJjaGJ5ZGF0ZXMgZG8gbm90IHdvcmsuXG4gIC8vIGNvbnN0IHR4bnMgPSBmaWx0ZXJUWEJ5RGF0ZShhY2NvdW50VHhzLCBzdGFydERhdGUpO1xuXG4gIHJldHVybiB7XG4gICAgYWNjb3VudE51bWJlcjogYWNjb3VudElELFxuICAgIHR4bnM6IGFjY291bnRUeHMsXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZldGNoQWNjb3VudHMocGFnZTogUGFnZSwgc3RhcnREYXRlOiBNb21lbnQpOiBQcm9taXNlPFRyYW5zYWN0aW9uc0FjY291bnRbXT4ge1xuICBjb25zdCBhY2NvdW50czogVHJhbnNhY3Rpb25zQWNjb3VudFtdID0gW107XG5cbiAgLy8gVE9ETzogZ2V0IG1vcmUgYWNjb3VudHNcbiAgY29uc3QgYWNjb3VudElEID0gYXdhaXQgZ2V0QWNjb3VudElEKHBhZ2UpO1xuICBjb25zdCBhY2NvdW50RGF0YSA9IGF3YWl0IGZldGNoQWNjb3VudERhdGEocGFnZSwgc3RhcnREYXRlLCBhY2NvdW50SUQpO1xuICBhY2NvdW50cy5wdXNoKGFjY291bnREYXRhKTtcblxuICByZXR1cm4gYWNjb3VudHM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHdhaXRSZWFkaW5lc3NGb3JBbGwocGFnZTogUGFnZSkge1xuICBhd2FpdCB3YWl0VW50aWxFbGVtZW50Rm91bmQocGFnZSwgYCR7VVNFUl9FTEVNfWAsIHRydWUpO1xuICBhd2FpdCB3YWl0VW50aWxFbGVtZW50Rm91bmQocGFnZSwgYCR7UEFTU1dEX0VMRU19YCwgdHJ1ZSk7XG4gIGF3YWl0IHdhaXRVbnRpbEVsZW1lbnRGb3VuZChwYWdlLCBgJHtOQVRJT05BTElEX0VMRU19YCwgdHJ1ZSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlZGlyZWN0T3JEaWFsb2cocGFnZTogUGFnZSkge1xuICAvLyBDbGljayBvbiBtZXNzYWdlc1xuICBhd2FpdCB3YWl0Rm9yTmF2aWdhdGlvbihwYWdlKTtcbiAgYXdhaXQgd2FpdFVudGlsRWxlbWVudERpc2FwcGVhcihwYWdlLCAnLmxvYWRpbmctYmFyLXNwaW5uZXInKTtcbiAgY29uc3QgaGFzTWVzc2FnZSA9IGF3YWl0IGVsZW1lbnRQcmVzZW50T25QYWdlKHBhZ2UsICcubWVzc2FnaW5nLWxpbmtzLWNvbnRhaW5lcicpO1xuICBpZiAoaGFzTWVzc2FnZSkge1xuICAgIGF3YWl0IGNsaWNrQnV0dG9uKHBhZ2UsICcubGluay0xJyk7XG4gIH1cblxuICBjb25zdCBwcm9taXNlMSA9IHBhZ2Uud2FpdEZvclNlbGVjdG9yKEFDQ09VTlRfREVUQUlMU19TRUxFQ1RPUiwgeyB0aW1lb3V0OiAzMDAwMCB9KTtcbiAgY29uc3QgcHJvbWlzZTIgPSBwYWdlLndhaXRGb3JTZWxlY3RvcihDSEFOR0VfUEFTU1dPUkRfT0xEX1BBU1MsIHsgdGltZW91dDogMzAwMDAgfSk7XG4gIGNvbnN0IHByb21pc2VzID0gW3Byb21pc2UxLCBwcm9taXNlMl07XG5cbiAgYXdhaXQgUHJvbWlzZS5yYWNlKHByb21pc2VzKTtcbiAgYXdhaXQgd2FpdFVudGlsRWxlbWVudERpc2FwcGVhcihwYWdlLCAnLmxvYWRpbmctYmFyLXNwaW5uZXInKTtcbn1cblxuY2xhc3MgWWFoYXZTY3JhcGVyIGV4dGVuZHMgQmFzZVNjcmFwZXJXaXRoQnJvd3NlciB7XG4gIGdldExvZ2luT3B0aW9ucyhjcmVkZW50aWFsczogU2NyYXBlckNyZWRlbnRpYWxzKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGxvZ2luVXJsOiBgJHtMT0dJTl9VUkx9YCxcbiAgICAgIGZpZWxkczogW1xuICAgICAgICB7IHNlbGVjdG9yOiBgJHtVU0VSX0VMRU19YCwgdmFsdWU6IGNyZWRlbnRpYWxzLnVzZXJuYW1lIH0sXG4gICAgICAgIHsgc2VsZWN0b3I6IGAke1BBU1NXRF9FTEVNfWAsIHZhbHVlOiBjcmVkZW50aWFscy5wYXNzd29yZCB9LFxuICAgICAgICB7IHNlbGVjdG9yOiBgJHtOQVRJT05BTElEX0VMRU19YCwgdmFsdWU6IGNyZWRlbnRpYWxzLm5hdGlvbmFsSUQgfSxcbiAgICAgIF0sXG4gICAgICBzdWJtaXRCdXR0b25TZWxlY3RvcjogJy5zdWJtaXQnLFxuICAgICAgY2hlY2tSZWFkaW5lc3M6IGFzeW5jICgpID0+IHdhaXRSZWFkaW5lc3NGb3JBbGwodGhpcy5wYWdlKSxcbiAgICAgIHBvc3RBY3Rpb246IGFzeW5jICgpID0+IHJlZGlyZWN0T3JEaWFsb2codGhpcy5wYWdlKSxcbiAgICAgIHBvc3NpYmxlUmVzdWx0czogZ2V0UG9zc2libGVMb2dpblJlc3VsdHModGhpcy5wYWdlKSxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgZmV0Y2hEYXRhKCkge1xuICAgIC8vIEdvdG8gc3RhdGVtZW50cyBwYWdlXG4gICAgYXdhaXQgd2FpdFVudGlsRWxlbWVudEZvdW5kKHRoaXMucGFnZSwgQUNDT1VOVF9ERVRBSUxTX1NFTEVDVE9SLCB0cnVlKTtcbiAgICBhd2FpdCBjbGlja0J1dHRvbih0aGlzLnBhZ2UsIEFDQ09VTlRfREVUQUlMU19TRUxFQ1RPUik7XG4gICAgYXdhaXQgd2FpdFVudGlsRWxlbWVudEZvdW5kKHRoaXMucGFnZSwgJy5zdGF0ZW1lbnQtb3B0aW9ucyAuc2VsZWN0ZWQtaXRlbS10b3AnLCB0cnVlKTtcblxuICAgIGNvbnN0IGRlZmF1bHRTdGFydE1vbWVudCA9IG1vbWVudCgpLnN1YnRyYWN0KDMsICdtb250aHMnKS5hZGQoMSwgJ2RheScpO1xuICAgIGNvbnN0IHN0YXJ0RGF0ZSA9IHRoaXMub3B0aW9ucy5zdGFydERhdGUgfHwgZGVmYXVsdFN0YXJ0TW9tZW50LnRvRGF0ZSgpO1xuICAgIGNvbnN0IHN0YXJ0TW9tZW50ID0gbW9tZW50Lm1heChkZWZhdWx0U3RhcnRNb21lbnQsIG1vbWVudChzdGFydERhdGUpKTtcblxuICAgIGNvbnN0IGFjY291bnRzID0gYXdhaXQgZmV0Y2hBY2NvdW50cyh0aGlzLnBhZ2UsIHN0YXJ0TW9tZW50KTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgYWNjb3VudHMsXG4gICAgfTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBZYWhhdlNjcmFwZXI7XG4iXX0=