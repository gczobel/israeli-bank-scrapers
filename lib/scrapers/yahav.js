"use strict";

require("core-js/modules/es.symbol.description");

require("core-js/modules/es.array.iterator");

require("core-js/modules/es.promise");

require("core-js/modules/es.string.replace");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _moment = _interopRequireDefault(require("moment"));

var _constants = require("../constants");

var _elementsInteractions = require("../helpers/elements-interactions");

var _navigation = require("../helpers/navigation");

var _transactions = require("../transactions");

var _baseScraperWithBrowser = require("./base-scraper-with-browser");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const LOGIN_URL = 'https://login.yahav.co.il/login/';
const BASE_URL = 'https://digital.yahav.co.il/BaNCSDigitalUI/app/index.html#/';
const INVALID_DETAILS_SELECTOR = '.ui-dialog-buttons';
const CHANGE_PASSWORD_OLD_PASS = 'input#ef_req_parameter_old_passwd';
const BASE_WELCOME_URL = `${BASE_URL}main/home`;
const ACCOUNT_ID_SELECTOR = '.dropdown-dir .selected-item-top';
const ACCOUNT_DETAILS_SELECTOR = '.account-details';
const DATE_FORMAT = 'DD/MM/YYYY';
const USER_ELEM = '#USER';
const PASSWD_ELEM = '#PASSWORD';
const NATIONALID_ELEM = '#NATIONAL_ID';

function getPossibleLoginResults(page) {
  // checkout file `base-scraper-with-browser.ts` for available result types
  const urls = {};
  urls[_baseScraperWithBrowser.LoginResults.Success] = [`${BASE_WELCOME_URL}`];
  urls[_baseScraperWithBrowser.LoginResults.InvalidPassword] = [async () => {
    return (0, _elementsInteractions.elementPresentOnPage)(page, `${INVALID_DETAILS_SELECTOR}`);
  }];
  urls[_baseScraperWithBrowser.LoginResults.ChangePassword] = [async () => {
    return (0, _elementsInteractions.elementPresentOnPage)(page, `${CHANGE_PASSWORD_OLD_PASS}`);
  }];
  return urls;
}

async function getAccountID(page) {
  const selectedSnifAccount = await page.$eval(`${ACCOUNT_ID_SELECTOR}`, option => {
    return option.innerText;
  });
  return selectedSnifAccount;
}

function getAmountData(amountStr) {
  const amountStrCopy = amountStr.replace(',', '');
  return parseFloat(amountStrCopy);
}

function getTxnAmount(txn) {
  const credit = getAmountData(txn.credit);
  const debit = getAmountData(txn.debit);
  return (Number.isNaN(credit) ? 0 : credit) - (Number.isNaN(debit) ? 0 : debit);
}

function convertTransactions(txns) {
  return txns.map(txn => {
    const convertedDate = (0, _moment.default)(txn.date, DATE_FORMAT).toISOString();
    const convertedAmount = getTxnAmount(txn);
    return {
      type: _transactions.TransactionTypes.Normal,
      identifier: txn.reference ? parseInt(txn.reference, 10) : undefined,
      date: convertedDate,
      processedDate: convertedDate,
      originalAmount: convertedAmount,
      originalCurrency: _constants.SHEKEL_CURRENCY,
      chargedAmount: convertedAmount,
      status: txn.status,
      description: txn.description,
      memo: txn.memo
    };
  });
}

function handleTransactionRow(txns, txnRow) {
  const div = txnRow.innerDivs; // Remove anything except digits.

  const regex = /\D+/gm;
  const tx = {
    date: div[1],
    reference: div[2].replace(regex, ''),
    memo: '',
    description: div[3],
    debit: div[4],
    credit: div[5],
    status: _transactions.TransactionStatuses.Completed
  };
  txns.push(tx);
}

async function sleep(ms) {
  await new Promise(resolve => setTimeout(resolve, ms));
}

async function getAccountTransactions(page) {
  // Wait for transactions.
  await (0, _elementsInteractions.waitUntilElementFound)(page, '.under-line-txn-table-header', true);
  const txns = [];
  const transactionsDivs = await (0, _elementsInteractions.pageEvalAll)(page, '.list-item-holder .entire-content-ctr', [], divs => {
    return divs.map(div => ({
      id: div.getAttribute('id') || '',
      innerDivs: Array.from(div.getElementsByTagName('div')).map(div => div.innerText)
    }));
  });

  for (const txnRow of transactionsDivs) {
    handleTransactionRow(txns, txnRow);
  }

  return convertTransactions(txns);
}

async function searchByDates(page)
/* , startDate: Moment */
{
  // TODO: Find a way to select the dates programatically.
  // Click on drop-down
  await (0, _elementsInteractions.clickButton)(page, '.statement-options .selected-item-top'); // Wait for drop-down creation

  await sleep(1000);
  let ddvalue = '';
  let item = 1;

  do {
    ddvalue = await page.$eval(`div.drop-down-item:nth-child(${item}) > div:nth-child(1) > span`, option => {
      return option.innerText;
    });

    if (ddvalue === '3 חודשים אחרונים') {
      break;
    }

    item += 1;
  } while (!_lodash.default.isEmpty(ddvalue)); // Click the 3 months transactions option


  await (0, _elementsInteractions.clickButton)(page, `div.drop-down-item:nth-child(${item}) > div:nth-child(1) > span`);
}

function filterTXByDate(txns, startDate) {
  const txs = _lodash.default.filter(txns, tx => {
    return startDate.isSameOrBefore(tx.date, 'day');
  });

  return txs;
}

async function fetchAccountData(page, startDate, accountID) {
  await searchByDates(page
  /* , startDate */
  );
  await (0, _elementsInteractions.waitUntilElementDisappear)(page, '.loading-bar-spinner');
  const accountTxs = await getAccountTransactions(page);
  const txns = filterTXByDate(accountTxs, startDate);
  return {
    accountNumber: accountID,
    txns
  };
}

async function fetchAccounts(page, startDate) {
  const accounts = []; // TODO: get more accounts

  const accountID = await getAccountID(page);
  const accountData = await fetchAccountData(page, startDate, accountID);
  accounts.push(accountData);
  return accounts;
}

async function waitReadinessForAll(page) {
  await (0, _elementsInteractions.waitUntilElementFound)(page, `${USER_ELEM}`, true);
  await (0, _elementsInteractions.waitUntilElementFound)(page, `${PASSWD_ELEM}`, true);
  await (0, _elementsInteractions.waitUntilElementFound)(page, `${NATIONALID_ELEM}`, true);
}

async function redirectOrDialog(page) {
  // Click on messages
  await (0, _navigation.waitForNavigation)(page);
  await (0, _elementsInteractions.waitUntilElementDisappear)(page, '.loading-bar-spinner');
  const hasMessage = await (0, _elementsInteractions.elementPresentOnPage)(page, '.messaging-links-container');

  if (hasMessage) {
    await (0, _elementsInteractions.clickButton)(page, '.link-1');
  }

  const promise1 = page.waitForSelector(ACCOUNT_DETAILS_SELECTOR, {
    timeout: 30000
  });
  const promise2 = page.waitForSelector(CHANGE_PASSWORD_OLD_PASS, {
    timeout: 30000
  });
  const promises = [promise1, promise2];
  await Promise.race(promises);
  await (0, _elementsInteractions.waitUntilElementDisappear)(page, '.loading-bar-spinner');
}

class YahavScraper extends _baseScraperWithBrowser.BaseScraperWithBrowser {
  getLoginOptions(credentials) {
    return {
      loginUrl: `${LOGIN_URL}`,
      fields: [{
        selector: `${USER_ELEM}`,
        value: credentials.username
      }, {
        selector: `${PASSWD_ELEM}`,
        value: credentials.password
      }, {
        selector: `${NATIONALID_ELEM}`,
        value: credentials.nationalID
      }],
      submitButtonSelector: '.submit',
      checkReadiness: async () => waitReadinessForAll(this.page),
      postAction: async () => redirectOrDialog(this.page),
      possibleResults: getPossibleLoginResults(this.page)
    };
  }

  async fetchData() {
    // Goto statements page
    await (0, _elementsInteractions.waitUntilElementFound)(this.page, ACCOUNT_DETAILS_SELECTOR, true);
    await (0, _elementsInteractions.clickButton)(this.page, ACCOUNT_DETAILS_SELECTOR);
    await (0, _elementsInteractions.waitUntilElementFound)(this.page, '.statement-options .selected-item-top', true);
    const defaultStartMoment = (0, _moment.default)().subtract(3, 'months').add(1, 'day');
    const startDate = this.options.startDate || defaultStartMoment.toDate();

    const startMoment = _moment.default.max(defaultStartMoment, (0, _moment.default)(startDate));

    const accounts = await fetchAccounts(this.page, startMoment);
    return {
      success: true,
      accounts
    };
  }

}

var _default = YahavScraper;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JhcGVycy95YWhhdi50cyJdLCJuYW1lcyI6WyJMT0dJTl9VUkwiLCJCQVNFX1VSTCIsIklOVkFMSURfREVUQUlMU19TRUxFQ1RPUiIsIkNIQU5HRV9QQVNTV09SRF9PTERfUEFTUyIsIkJBU0VfV0VMQ09NRV9VUkwiLCJBQ0NPVU5UX0lEX1NFTEVDVE9SIiwiQUNDT1VOVF9ERVRBSUxTX1NFTEVDVE9SIiwiREFURV9GT1JNQVQiLCJVU0VSX0VMRU0iLCJQQVNTV0RfRUxFTSIsIk5BVElPTkFMSURfRUxFTSIsImdldFBvc3NpYmxlTG9naW5SZXN1bHRzIiwicGFnZSIsInVybHMiLCJMb2dpblJlc3VsdHMiLCJTdWNjZXNzIiwiSW52YWxpZFBhc3N3b3JkIiwiQ2hhbmdlUGFzc3dvcmQiLCJnZXRBY2NvdW50SUQiLCJzZWxlY3RlZFNuaWZBY2NvdW50IiwiJGV2YWwiLCJvcHRpb24iLCJpbm5lclRleHQiLCJnZXRBbW91bnREYXRhIiwiYW1vdW50U3RyIiwiYW1vdW50U3RyQ29weSIsInJlcGxhY2UiLCJwYXJzZUZsb2F0IiwiZ2V0VHhuQW1vdW50IiwidHhuIiwiY3JlZGl0IiwiZGViaXQiLCJOdW1iZXIiLCJpc05hTiIsImNvbnZlcnRUcmFuc2FjdGlvbnMiLCJ0eG5zIiwibWFwIiwiY29udmVydGVkRGF0ZSIsImRhdGUiLCJ0b0lTT1N0cmluZyIsImNvbnZlcnRlZEFtb3VudCIsInR5cGUiLCJUcmFuc2FjdGlvblR5cGVzIiwiTm9ybWFsIiwiaWRlbnRpZmllciIsInJlZmVyZW5jZSIsInBhcnNlSW50IiwidW5kZWZpbmVkIiwicHJvY2Vzc2VkRGF0ZSIsIm9yaWdpbmFsQW1vdW50Iiwib3JpZ2luYWxDdXJyZW5jeSIsIlNIRUtFTF9DVVJSRU5DWSIsImNoYXJnZWRBbW91bnQiLCJzdGF0dXMiLCJkZXNjcmlwdGlvbiIsIm1lbW8iLCJoYW5kbGVUcmFuc2FjdGlvblJvdyIsInR4blJvdyIsImRpdiIsImlubmVyRGl2cyIsInJlZ2V4IiwidHgiLCJUcmFuc2FjdGlvblN0YXR1c2VzIiwiQ29tcGxldGVkIiwicHVzaCIsInNsZWVwIiwibXMiLCJQcm9taXNlIiwicmVzb2x2ZSIsInNldFRpbWVvdXQiLCJnZXRBY2NvdW50VHJhbnNhY3Rpb25zIiwidHJhbnNhY3Rpb25zRGl2cyIsImRpdnMiLCJpZCIsImdldEF0dHJpYnV0ZSIsIkFycmF5IiwiZnJvbSIsImdldEVsZW1lbnRzQnlUYWdOYW1lIiwic2VhcmNoQnlEYXRlcyIsImRkdmFsdWUiLCJpdGVtIiwiXyIsImlzRW1wdHkiLCJmaWx0ZXJUWEJ5RGF0ZSIsInN0YXJ0RGF0ZSIsInR4cyIsImZpbHRlciIsImlzU2FtZU9yQmVmb3JlIiwiZmV0Y2hBY2NvdW50RGF0YSIsImFjY291bnRJRCIsImFjY291bnRUeHMiLCJhY2NvdW50TnVtYmVyIiwiZmV0Y2hBY2NvdW50cyIsImFjY291bnRzIiwiYWNjb3VudERhdGEiLCJ3YWl0UmVhZGluZXNzRm9yQWxsIiwicmVkaXJlY3RPckRpYWxvZyIsImhhc01lc3NhZ2UiLCJwcm9taXNlMSIsIndhaXRGb3JTZWxlY3RvciIsInRpbWVvdXQiLCJwcm9taXNlMiIsInByb21pc2VzIiwicmFjZSIsIllhaGF2U2NyYXBlciIsIkJhc2VTY3JhcGVyV2l0aEJyb3dzZXIiLCJnZXRMb2dpbk9wdGlvbnMiLCJjcmVkZW50aWFscyIsImxvZ2luVXJsIiwiZmllbGRzIiwic2VsZWN0b3IiLCJ2YWx1ZSIsInVzZXJuYW1lIiwicGFzc3dvcmQiLCJuYXRpb25hbElEIiwic3VibWl0QnV0dG9uU2VsZWN0b3IiLCJjaGVja1JlYWRpbmVzcyIsInBvc3RBY3Rpb24iLCJwb3NzaWJsZVJlc3VsdHMiLCJmZXRjaERhdGEiLCJkZWZhdWx0U3RhcnRNb21lbnQiLCJzdWJ0cmFjdCIsImFkZCIsIm9wdGlvbnMiLCJ0b0RhdGUiLCJzdGFydE1vbWVudCIsIm1vbWVudCIsIm1heCIsInN1Y2Nlc3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztB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QUFLTSxJQUFqQixFQUF1Qk4sd0JBQXZCLENBQU47QUFDQSxVQUFNLGlEQUFzQixLQUFLTSxJQUEzQixFQUFpQyx1Q0FBakMsRUFBMEUsSUFBMUUsQ0FBTjtBQUVBLFVBQU00RyxrQkFBa0IsR0FBRyx1QkFBU0MsUUFBVCxDQUFrQixDQUFsQixFQUFxQixRQUFyQixFQUErQkMsR0FBL0IsQ0FBbUMsQ0FBbkMsRUFBc0MsS0FBdEMsQ0FBM0I7QUFDQSxVQUFNdEMsU0FBUyxHQUFHLEtBQUt1QyxPQUFMLENBQWF2QyxTQUFiLElBQTBCb0Msa0JBQWtCLENBQUNJLE1BQW5CLEVBQTVDOztBQUNBLFVBQU1DLFdBQVcsR0FBR0MsZ0JBQU9DLEdBQVAsQ0FBV1Asa0JBQVgsRUFBK0IscUJBQU9wQyxTQUFQLENBQS9CLENBQXBCOztBQUVBLFVBQU1TLFFBQVEsR0FBRyxNQUFNRCxhQUFhLENBQUMsS0FBS2hGLElBQU4sRUFBWWlILFdBQVosQ0FBcEM7QUFFQSxXQUFPO0FBQ0xHLE1BQUFBLE9BQU8sRUFBRSxJQURKO0FBRUxuQyxNQUFBQTtBQUZLLEtBQVA7QUFJRDs7QUFoQytDOztlQW9DbkNXLFkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IG1vbWVudCwgeyBNb21lbnQgfSBmcm9tICdtb21lbnQnO1xuaW1wb3J0IHsgUGFnZSB9IGZyb20gJ3B1cHBldGVlcic7XG5pbXBvcnQgeyBTSEVLRUxfQ1VSUkVOQ1kgfSBmcm9tICcuLi9jb25zdGFudHMnO1xuaW1wb3J0IHtcbiAgY2xpY2tCdXR0b24sIGVsZW1lbnRQcmVzZW50T25QYWdlLFxuICBwYWdlRXZhbEFsbCwgd2FpdFVudGlsRWxlbWVudERpc2FwcGVhciwgd2FpdFVudGlsRWxlbWVudEZvdW5kLFxufSBmcm9tICcuLi9oZWxwZXJzL2VsZW1lbnRzLWludGVyYWN0aW9ucyc7XG5pbXBvcnQgeyB3YWl0Rm9yTmF2aWdhdGlvbiB9IGZyb20gJy4uL2hlbHBlcnMvbmF2aWdhdGlvbic7XG5pbXBvcnQge1xuICBUcmFuc2FjdGlvbiwgVHJhbnNhY3Rpb25zQWNjb3VudCxcbiAgVHJhbnNhY3Rpb25TdGF0dXNlcywgVHJhbnNhY3Rpb25UeXBlcyxcbn0gZnJvbSAnLi4vdHJhbnNhY3Rpb25zJztcbmltcG9ydCB7IFNjcmFwZXJDcmVkZW50aWFscyB9IGZyb20gJy4vYmFzZS1zY3JhcGVyJztcbmltcG9ydCB7XG4gIEJhc2VTY3JhcGVyV2l0aEJyb3dzZXIsXG4gIExvZ2luUmVzdWx0cyxcbiAgUG9zc2libGVMb2dpblJlc3VsdHMsXG59IGZyb20gJy4vYmFzZS1zY3JhcGVyLXdpdGgtYnJvd3Nlcic7XG5cbmNvbnN0IExPR0lOX1VSTCA9ICdodHRwczovL2xvZ2luLnlhaGF2LmNvLmlsL2xvZ2luLyc7XG5jb25zdCBCQVNFX1VSTCA9ICdodHRwczovL2RpZ2l0YWwueWFoYXYuY28uaWwvQmFOQ1NEaWdpdGFsVUkvYXBwL2luZGV4Lmh0bWwjLyc7XG5jb25zdCBJTlZBTElEX0RFVEFJTFNfU0VMRUNUT1IgPSAnLnVpLWRpYWxvZy1idXR0b25zJztcbmNvbnN0IENIQU5HRV9QQVNTV09SRF9PTERfUEFTUyA9ICdpbnB1dCNlZl9yZXFfcGFyYW1ldGVyX29sZF9wYXNzd2QnO1xuY29uc3QgQkFTRV9XRUxDT01FX1VSTCA9IGAke0JBU0VfVVJMfW1haW4vaG9tZWA7XG5cbmNvbnN0IEFDQ09VTlRfSURfU0VMRUNUT1IgPSAnLmRyb3Bkb3duLWRpciAuc2VsZWN0ZWQtaXRlbS10b3AnO1xuY29uc3QgQUNDT1VOVF9ERVRBSUxTX1NFTEVDVE9SID0gJy5hY2NvdW50LWRldGFpbHMnO1xuY29uc3QgREFURV9GT1JNQVQgPSAnREQvTU0vWVlZWSc7XG5cbmNvbnN0IFVTRVJfRUxFTSA9ICcjVVNFUic7XG5jb25zdCBQQVNTV0RfRUxFTSA9ICcjUEFTU1dPUkQnO1xuY29uc3QgTkFUSU9OQUxJRF9FTEVNID0gJyNOQVRJT05BTF9JRCc7XG5cbmludGVyZmFjZSBTY3JhcGVkVHJhbnNhY3Rpb24ge1xuICBjcmVkaXQ6IHN0cmluZztcbiAgZGViaXQ6IHN0cmluZztcbiAgZGF0ZTogc3RyaW5nO1xuICByZWZlcmVuY2U/OiBzdHJpbmc7XG4gIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gIG1lbW86IHN0cmluZztcbiAgc3RhdHVzOiBUcmFuc2FjdGlvblN0YXR1c2VzO1xufVxuXG5mdW5jdGlvbiBnZXRQb3NzaWJsZUxvZ2luUmVzdWx0cyhwYWdlOiBQYWdlKTogUG9zc2libGVMb2dpblJlc3VsdHMge1xuICAvLyBjaGVja291dCBmaWxlIGBiYXNlLXNjcmFwZXItd2l0aC1icm93c2VyLnRzYCBmb3IgYXZhaWxhYmxlIHJlc3VsdCB0eXBlc1xuICBjb25zdCB1cmxzOiBQb3NzaWJsZUxvZ2luUmVzdWx0cyA9IHt9O1xuICB1cmxzW0xvZ2luUmVzdWx0cy5TdWNjZXNzXSA9IFtcbiAgICBgJHtCQVNFX1dFTENPTUVfVVJMfWAsXG4gIF07XG4gIHVybHNbTG9naW5SZXN1bHRzLkludmFsaWRQYXNzd29yZF0gPSBbYXN5bmMgKCkgPT4ge1xuICAgIHJldHVybiBlbGVtZW50UHJlc2VudE9uUGFnZShwYWdlLCBgJHtJTlZBTElEX0RFVEFJTFNfU0VMRUNUT1J9YCk7XG4gIH1dO1xuXG4gIHVybHNbTG9naW5SZXN1bHRzLkNoYW5nZVBhc3N3b3JkXSA9IFthc3luYyAoKSA9PiB7XG4gICAgcmV0dXJuIGVsZW1lbnRQcmVzZW50T25QYWdlKHBhZ2UsIGAke0NIQU5HRV9QQVNTV09SRF9PTERfUEFTU31gKTtcbiAgfV07XG5cbiAgcmV0dXJuIHVybHM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFjY291bnRJRChwYWdlOiBQYWdlKSB7XG4gIGNvbnN0IHNlbGVjdGVkU25pZkFjY291bnQgPSBhd2FpdCBwYWdlLiRldmFsKGAke0FDQ09VTlRfSURfU0VMRUNUT1J9YCwgKG9wdGlvbikgPT4ge1xuICAgIHJldHVybiAob3B0aW9uIGFzIEhUTUxFbGVtZW50KS5pbm5lclRleHQ7XG4gIH0pO1xuXG4gIHJldHVybiBzZWxlY3RlZFNuaWZBY2NvdW50O1xufVxuXG5mdW5jdGlvbiBnZXRBbW91bnREYXRhKGFtb3VudFN0cjogc3RyaW5nKSB7XG4gIGNvbnN0IGFtb3VudFN0ckNvcHkgPSBhbW91bnRTdHIucmVwbGFjZSgnLCcsICcnKTtcbiAgcmV0dXJuIHBhcnNlRmxvYXQoYW1vdW50U3RyQ29weSk7XG59XG5cbmZ1bmN0aW9uIGdldFR4bkFtb3VudCh0eG46IFNjcmFwZWRUcmFuc2FjdGlvbikge1xuICBjb25zdCBjcmVkaXQgPSBnZXRBbW91bnREYXRhKHR4bi5jcmVkaXQpO1xuICBjb25zdCBkZWJpdCA9IGdldEFtb3VudERhdGEodHhuLmRlYml0KTtcbiAgcmV0dXJuIChOdW1iZXIuaXNOYU4oY3JlZGl0KSA/IDAgOiBjcmVkaXQpIC0gKE51bWJlci5pc05hTihkZWJpdCkgPyAwIDogZGViaXQpO1xufVxuXG50eXBlIFRyYW5zYWN0aW9uc1RyID0geyBpZDogc3RyaW5nLCBpbm5lckRpdnM6IHN0cmluZ1tdIH07XG5cbmZ1bmN0aW9uIGNvbnZlcnRUcmFuc2FjdGlvbnModHhuczogU2NyYXBlZFRyYW5zYWN0aW9uW10pOiBUcmFuc2FjdGlvbltdIHtcbiAgcmV0dXJuIHR4bnMubWFwKCh0eG4pID0+IHtcbiAgICBjb25zdCBjb252ZXJ0ZWREYXRlID0gbW9tZW50KHR4bi5kYXRlLCBEQVRFX0ZPUk1BVCkudG9JU09TdHJpbmcoKTtcbiAgICBjb25zdCBjb252ZXJ0ZWRBbW91bnQgPSBnZXRUeG5BbW91bnQodHhuKTtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogVHJhbnNhY3Rpb25UeXBlcy5Ob3JtYWwsXG4gICAgICBpZGVudGlmaWVyOiB0eG4ucmVmZXJlbmNlID8gcGFyc2VJbnQodHhuLnJlZmVyZW5jZSwgMTApIDogdW5kZWZpbmVkLFxuICAgICAgZGF0ZTogY29udmVydGVkRGF0ZSxcbiAgICAgIHByb2Nlc3NlZERhdGU6IGNvbnZlcnRlZERhdGUsXG4gICAgICBvcmlnaW5hbEFtb3VudDogY29udmVydGVkQW1vdW50LFxuICAgICAgb3JpZ2luYWxDdXJyZW5jeTogU0hFS0VMX0NVUlJFTkNZLFxuICAgICAgY2hhcmdlZEFtb3VudDogY29udmVydGVkQW1vdW50LFxuICAgICAgc3RhdHVzOiB0eG4uc3RhdHVzLFxuICAgICAgZGVzY3JpcHRpb246IHR4bi5kZXNjcmlwdGlvbixcbiAgICAgIG1lbW86IHR4bi5tZW1vLFxuICAgIH07XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBoYW5kbGVUcmFuc2FjdGlvblJvdyh0eG5zOiBTY3JhcGVkVHJhbnNhY3Rpb25bXSwgdHhuUm93OiBUcmFuc2FjdGlvbnNUcikge1xuICBjb25zdCBkaXYgPSB0eG5Sb3cuaW5uZXJEaXZzO1xuXG4gIC8vIFJlbW92ZSBhbnl0aGluZyBleGNlcHQgZGlnaXRzLlxuICBjb25zdCByZWdleCA9IC9cXEQrL2dtO1xuXG4gIGNvbnN0IHR4OiBTY3JhcGVkVHJhbnNhY3Rpb24gPSB7XG4gICAgZGF0ZTogZGl2WzFdLFxuICAgIHJlZmVyZW5jZTogZGl2WzJdLnJlcGxhY2UocmVnZXgsICcnKSxcbiAgICBtZW1vOiAnJyxcbiAgICBkZXNjcmlwdGlvbjogZGl2WzNdLFxuICAgIGRlYml0OiBkaXZbNF0sXG4gICAgY3JlZGl0OiBkaXZbNV0sXG4gICAgc3RhdHVzOiBUcmFuc2FjdGlvblN0YXR1c2VzLkNvbXBsZXRlZCxcbiAgfTtcblxuICB0eG5zLnB1c2godHgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzbGVlcChtczogbnVtYmVyKSB7XG4gIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFjY291bnRUcmFuc2FjdGlvbnMocGFnZTogUGFnZSk6IFByb21pc2U8VHJhbnNhY3Rpb25bXT4ge1xuICAvLyBXYWl0IGZvciB0cmFuc2FjdGlvbnMuXG4gIGF3YWl0IHdhaXRVbnRpbEVsZW1lbnRGb3VuZChwYWdlLCAnLnVuZGVyLWxpbmUtdHhuLXRhYmxlLWhlYWRlcicsIHRydWUpO1xuXG4gIGNvbnN0IHR4bnM6IFNjcmFwZWRUcmFuc2FjdGlvbltdID0gW107XG4gIGNvbnN0IHRyYW5zYWN0aW9uc0RpdnMgPSBhd2FpdCBwYWdlRXZhbEFsbDxUcmFuc2FjdGlvbnNUcltdPihwYWdlLCAnLmxpc3QtaXRlbS1ob2xkZXIgLmVudGlyZS1jb250ZW50LWN0cicsIFtdLCAoZGl2cykgPT4ge1xuICAgIHJldHVybiAoZGl2cyBhcyBIVE1MRWxlbWVudFtdKS5tYXAoKGRpdikgPT4gKHtcbiAgICAgIGlkOiAoZGl2KS5nZXRBdHRyaWJ1dGUoJ2lkJykgfHwgJycsXG4gICAgICBpbm5lckRpdnM6IEFycmF5LmZyb20oZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdkaXYnKSkubWFwKChkaXYpID0+IChkaXYgYXMgSFRNTEVsZW1lbnQpLmlubmVyVGV4dCksXG4gICAgfSkpO1xuICB9KTtcblxuICBmb3IgKGNvbnN0IHR4blJvdyBvZiB0cmFuc2FjdGlvbnNEaXZzKSB7XG4gICAgaGFuZGxlVHJhbnNhY3Rpb25Sb3codHhucywgdHhuUm93KTtcbiAgfVxuXG4gIHJldHVybiBjb252ZXJ0VHJhbnNhY3Rpb25zKHR4bnMpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZWFyY2hCeURhdGVzKHBhZ2U6IFBhZ2UvKiAsIHN0YXJ0RGF0ZTogTW9tZW50ICovKSB7XG4gIC8vIFRPRE86IEZpbmQgYSB3YXkgdG8gc2VsZWN0IHRoZSBkYXRlcyBwcm9ncmFtYXRpY2FsbHkuXG5cbiAgLy8gQ2xpY2sgb24gZHJvcC1kb3duXG4gIGF3YWl0IGNsaWNrQnV0dG9uKHBhZ2UsICcuc3RhdGVtZW50LW9wdGlvbnMgLnNlbGVjdGVkLWl0ZW0tdG9wJyk7XG5cbiAgLy8gV2FpdCBmb3IgZHJvcC1kb3duIGNyZWF0aW9uXG4gIGF3YWl0IHNsZWVwKDEwMDApO1xuXG4gIGxldCBkZHZhbHVlID0gJyc7XG4gIGxldCBpdGVtID0gMTtcbiAgZG8ge1xuICAgIGRkdmFsdWUgPSBhd2FpdCBwYWdlLiRldmFsKGBkaXYuZHJvcC1kb3duLWl0ZW06bnRoLWNoaWxkKCR7aXRlbX0pID4gZGl2Om50aC1jaGlsZCgxKSA+IHNwYW5gLCAob3B0aW9uKSA9PiB7XG4gICAgICByZXR1cm4gKG9wdGlvbiBhcyBIVE1MRWxlbWVudCkuaW5uZXJUZXh0O1xuICAgIH0pO1xuXG4gICAgaWYgKGRkdmFsdWUgPT09ICczINeX15XXk9ep15nXnSDXkNeX16jXldeg15nXnScpIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBpdGVtICs9IDE7XG4gIH1cbiAgd2hpbGUgKCFfLmlzRW1wdHkoZGR2YWx1ZSkpO1xuXG5cbiAgLy8gQ2xpY2sgdGhlIDMgbW9udGhzIHRyYW5zYWN0aW9ucyBvcHRpb25cbiAgYXdhaXQgY2xpY2tCdXR0b24ocGFnZSwgYGRpdi5kcm9wLWRvd24taXRlbTpudGgtY2hpbGQoJHtpdGVtfSkgPiBkaXY6bnRoLWNoaWxkKDEpID4gc3BhbmApO1xufVxuXG5mdW5jdGlvbiBmaWx0ZXJUWEJ5RGF0ZSh0eG5zOiBUcmFuc2FjdGlvbltdLCBzdGFydERhdGU6IE1vbWVudCk6IFRyYW5zYWN0aW9uW10ge1xuICBjb25zdCB0eHMgPSBfLmZpbHRlcih0eG5zLCAodHgpID0+IHtcbiAgICByZXR1cm4gc3RhcnREYXRlLmlzU2FtZU9yQmVmb3JlKHR4LmRhdGUsICdkYXknKTtcbiAgfSk7XG5cbiAgcmV0dXJuIHR4cztcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmV0Y2hBY2NvdW50RGF0YShwYWdlOiBQYWdlLCBzdGFydERhdGU6IE1vbWVudCwgYWNjb3VudElEOiBzdHJpbmcpOiBQcm9taXNlPFRyYW5zYWN0aW9uc0FjY291bnQ+IHtcbiAgYXdhaXQgc2VhcmNoQnlEYXRlcyhwYWdlLyogLCBzdGFydERhdGUgKi8pO1xuICBhd2FpdCB3YWl0VW50aWxFbGVtZW50RGlzYXBwZWFyKHBhZ2UsICcubG9hZGluZy1iYXItc3Bpbm5lcicpO1xuICBjb25zdCBhY2NvdW50VHhzID0gYXdhaXQgZ2V0QWNjb3VudFRyYW5zYWN0aW9ucyhwYWdlKTtcbiAgY29uc3QgdHhucyA9IGZpbHRlclRYQnlEYXRlKGFjY291bnRUeHMsIHN0YXJ0RGF0ZSk7XG5cbiAgcmV0dXJuIHtcbiAgICBhY2NvdW50TnVtYmVyOiBhY2NvdW50SUQsXG4gICAgdHhucyxcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmV0Y2hBY2NvdW50cyhwYWdlOiBQYWdlLCBzdGFydERhdGU6IE1vbWVudCk6IFByb21pc2U8VHJhbnNhY3Rpb25zQWNjb3VudFtdPiB7XG4gIGNvbnN0IGFjY291bnRzOiBUcmFuc2FjdGlvbnNBY2NvdW50W10gPSBbXTtcblxuICAvLyBUT0RPOiBnZXQgbW9yZSBhY2NvdW50c1xuICBjb25zdCBhY2NvdW50SUQgPSBhd2FpdCBnZXRBY2NvdW50SUQocGFnZSk7XG4gIGNvbnN0IGFjY291bnREYXRhID0gYXdhaXQgZmV0Y2hBY2NvdW50RGF0YShwYWdlLCBzdGFydERhdGUsIGFjY291bnRJRCk7XG4gIGFjY291bnRzLnB1c2goYWNjb3VudERhdGEpO1xuXG4gIHJldHVybiBhY2NvdW50cztcbn1cblxuYXN5bmMgZnVuY3Rpb24gd2FpdFJlYWRpbmVzc0ZvckFsbChwYWdlOiBQYWdlKSB7XG4gIGF3YWl0IHdhaXRVbnRpbEVsZW1lbnRGb3VuZChwYWdlLCBgJHtVU0VSX0VMRU19YCwgdHJ1ZSk7XG4gIGF3YWl0IHdhaXRVbnRpbEVsZW1lbnRGb3VuZChwYWdlLCBgJHtQQVNTV0RfRUxFTX1gLCB0cnVlKTtcbiAgYXdhaXQgd2FpdFVudGlsRWxlbWVudEZvdW5kKHBhZ2UsIGAke05BVElPTkFMSURfRUxFTX1gLCB0cnVlKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVkaXJlY3RPckRpYWxvZyhwYWdlOiBQYWdlKSB7XG4gIC8vIENsaWNrIG9uIG1lc3NhZ2VzXG4gIGF3YWl0IHdhaXRGb3JOYXZpZ2F0aW9uKHBhZ2UpO1xuICBhd2FpdCB3YWl0VW50aWxFbGVtZW50RGlzYXBwZWFyKHBhZ2UsICcubG9hZGluZy1iYXItc3Bpbm5lcicpO1xuICBjb25zdCBoYXNNZXNzYWdlID0gYXdhaXQgZWxlbWVudFByZXNlbnRPblBhZ2UocGFnZSwgJy5tZXNzYWdpbmctbGlua3MtY29udGFpbmVyJyk7XG4gIGlmIChoYXNNZXNzYWdlKSB7XG4gICAgYXdhaXQgY2xpY2tCdXR0b24ocGFnZSwgJy5saW5rLTEnKTtcbiAgfVxuXG4gIGNvbnN0IHByb21pc2UxID0gcGFnZS53YWl0Rm9yU2VsZWN0b3IoQUNDT1VOVF9ERVRBSUxTX1NFTEVDVE9SLCB7IHRpbWVvdXQ6IDMwMDAwIH0pO1xuICBjb25zdCBwcm9taXNlMiA9IHBhZ2Uud2FpdEZvclNlbGVjdG9yKENIQU5HRV9QQVNTV09SRF9PTERfUEFTUywgeyB0aW1lb3V0OiAzMDAwMCB9KTtcbiAgY29uc3QgcHJvbWlzZXMgPSBbcHJvbWlzZTEsIHByb21pc2UyXTtcblxuICBhd2FpdCBQcm9taXNlLnJhY2UocHJvbWlzZXMpO1xuICBhd2FpdCB3YWl0VW50aWxFbGVtZW50RGlzYXBwZWFyKHBhZ2UsICcubG9hZGluZy1iYXItc3Bpbm5lcicpO1xufVxuXG5jbGFzcyBZYWhhdlNjcmFwZXIgZXh0ZW5kcyBCYXNlU2NyYXBlcldpdGhCcm93c2VyIHtcbiAgZ2V0TG9naW5PcHRpb25zKGNyZWRlbnRpYWxzOiBTY3JhcGVyQ3JlZGVudGlhbHMpIHtcbiAgICByZXR1cm4ge1xuICAgICAgbG9naW5Vcmw6IGAke0xPR0lOX1VSTH1gLFxuICAgICAgZmllbGRzOiBbXG4gICAgICAgIHsgc2VsZWN0b3I6IGAke1VTRVJfRUxFTX1gLCB2YWx1ZTogY3JlZGVudGlhbHMudXNlcm5hbWUgfSxcbiAgICAgICAgeyBzZWxlY3RvcjogYCR7UEFTU1dEX0VMRU19YCwgdmFsdWU6IGNyZWRlbnRpYWxzLnBhc3N3b3JkIH0sXG4gICAgICAgIHsgc2VsZWN0b3I6IGAke05BVElPTkFMSURfRUxFTX1gLCB2YWx1ZTogY3JlZGVudGlhbHMubmF0aW9uYWxJRCB9LFxuICAgICAgXSxcbiAgICAgIHN1Ym1pdEJ1dHRvblNlbGVjdG9yOiAnLnN1Ym1pdCcsXG4gICAgICBjaGVja1JlYWRpbmVzczogYXN5bmMgKCkgPT4gd2FpdFJlYWRpbmVzc0ZvckFsbCh0aGlzLnBhZ2UpLFxuICAgICAgcG9zdEFjdGlvbjogYXN5bmMgKCkgPT4gcmVkaXJlY3RPckRpYWxvZyh0aGlzLnBhZ2UpLFxuICAgICAgcG9zc2libGVSZXN1bHRzOiBnZXRQb3NzaWJsZUxvZ2luUmVzdWx0cyh0aGlzLnBhZ2UpLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBmZXRjaERhdGEoKSB7XG4gICAgLy8gR290byBzdGF0ZW1lbnRzIHBhZ2VcbiAgICBhd2FpdCB3YWl0VW50aWxFbGVtZW50Rm91bmQodGhpcy5wYWdlLCBBQ0NPVU5UX0RFVEFJTFNfU0VMRUNUT1IsIHRydWUpO1xuICAgIGF3YWl0IGNsaWNrQnV0dG9uKHRoaXMucGFnZSwgQUNDT1VOVF9ERVRBSUxTX1NFTEVDVE9SKTtcbiAgICBhd2FpdCB3YWl0VW50aWxFbGVtZW50Rm91bmQodGhpcy5wYWdlLCAnLnN0YXRlbWVudC1vcHRpb25zIC5zZWxlY3RlZC1pdGVtLXRvcCcsIHRydWUpO1xuXG4gICAgY29uc3QgZGVmYXVsdFN0YXJ0TW9tZW50ID0gbW9tZW50KCkuc3VidHJhY3QoMywgJ21vbnRocycpLmFkZCgxLCAnZGF5Jyk7XG4gICAgY29uc3Qgc3RhcnREYXRlID0gdGhpcy5vcHRpb25zLnN0YXJ0RGF0ZSB8fCBkZWZhdWx0U3RhcnRNb21lbnQudG9EYXRlKCk7XG4gICAgY29uc3Qgc3RhcnRNb21lbnQgPSBtb21lbnQubWF4KGRlZmF1bHRTdGFydE1vbWVudCwgbW9tZW50KHN0YXJ0RGF0ZSkpO1xuXG4gICAgY29uc3QgYWNjb3VudHMgPSBhd2FpdCBmZXRjaEFjY291bnRzKHRoaXMucGFnZSwgc3RhcnRNb21lbnQpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBhY2NvdW50cyxcbiAgICB9O1xuICB9XG59XG5cblxuZXhwb3J0IGRlZmF1bHQgWWFoYXZTY3JhcGVyO1xuIl19