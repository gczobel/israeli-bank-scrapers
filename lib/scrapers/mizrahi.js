"use strict";

require("core-js/modules/es.array.iterator");

require("core-js/modules/es.promise");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _moment = _interopRequireDefault(require("moment"));

var _constants = require("../constants");

var _elementsInteractions = require("../helpers/elements-interactions");

var _fetch = require("../helpers/fetch");

var _transactions = require("../transactions");

var _baseScraper = require("./base-scraper");

var _baseScraperWithBrowser = require("./base-scraper-with-browser");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const BASE_WEBSITE_URL = 'https://www.mizrahi-tefahot.co.il';
const LOGIN_URL = `${BASE_WEBSITE_URL}/login/index.html#/auth-page-he`;
const BASE_APP_URL = 'https://mto.mizrahi-tefahot.co.il';
const AFTER_LOGIN_BASE_URL = /https:\/\/mto\.mizrahi-tefahot\.co\.il\/ngOnline\/index\.html#\/main\/uis/;
const OSH_PAGE = `${BASE_APP_URL}/ngOnline/index.html#/main/uis/osh/p428/`;
const TRANSACTIONS_REQUEST_URL = `${BASE_APP_URL}/Online/api/SkyOSH/get428Index`;
const PENDING_TRANSACTIONS_PAGE = `${BASE_APP_URL}/Online/Osh/p420.aspx`;
const CHANGE_PASSWORD_URL = `${AFTER_LOGIN_BASE_URL}/main/uis/ge/changePassword/`;
const DATE_FORMAT = 'DD/MM/YYYY';
const MAX_ROWS_PER_REQUEST = 10000000000;
const usernameSelector = '#emailDesktopHeb';
const passwordSelector = '#passwordIDDesktopHEB';
const submitButtonSelector = '.form-desktop button';
const invalidPasswordSelector = 'a[href*="https://sc.mizrahi-tefahot.co.il/SCServices/SC/P010.aspx"]';
const afterLoginSelector = '#stickyHeaderScrollRegion';
const loginSpinnerSelector = 'div.ngx-overlay.loading-foreground';

function createLoginFields(credentials) {
  return [{
    selector: usernameSelector,
    value: credentials.username
  }, {
    selector: passwordSelector,
    value: credentials.password
  }];
}

function getPossibleLoginResults(page) {
  return {
    [_baseScraperWithBrowser.LoginResults.Success]: [AFTER_LOGIN_BASE_URL],
    [_baseScraperWithBrowser.LoginResults.InvalidPassword]: [async () => !!(await page.$(invalidPasswordSelector))],
    [_baseScraperWithBrowser.LoginResults.ChangePassword]: [CHANGE_PASSWORD_URL]
  };
}

function CreateDataFromRequest(request, optionsStartDate) {
  const defaultStartMoment = (0, _moment.default)().subtract(1, 'years');
  const startDate = optionsStartDate || defaultStartMoment.toDate();

  const startMoment = _moment.default.max(defaultStartMoment, (0, _moment.default)(startDate));

  const data = JSON.parse(request.postData() || '{}');
  data.inToDate = (0, _moment.default)().format(DATE_FORMAT);
  data.inFromDate = startMoment.format(DATE_FORMAT);
  data.table.maxRow = MAX_ROWS_PER_REQUEST;
  return data;
}

function createHeadersFromRequest(request) {
  return {
    mizrahixsrftoken: request.headers().mizrahixsrftoken,
    'Content-Type': request.headers()['content-type']
  };
}

function convertTransactions(txns) {
  return txns.map(row => {
    const txnDate = (0, _moment.default)(row.MC02PeulaTaaEZ, _moment.default.HTML5_FMT.DATETIME_LOCAL_SECONDS).toISOString();
    return {
      type: _transactions.TransactionTypes.Normal,
      identifier: row.MC02AsmahtaMekoritEZ ? parseInt(row.MC02AsmahtaMekoritEZ, 10) : undefined,
      date: txnDate,
      processedDate: txnDate,
      originalAmount: row.MC02SchumEZ,
      originalCurrency: _constants.SHEKEL_CURRENCY,
      chargedAmount: row.MC02SchumEZ,
      description: row.MC02TnuaTeurEZ,
      status: _transactions.TransactionStatuses.Completed
    };
  });
}

async function extractPendingTransactions(page) {
  const pendingTxn = await (0, _elementsInteractions.pageEvalAll)(page, 'tr.rgRow', [], trs => {
    return trs.map(tr => Array.from(tr.querySelectorAll('td'), td => td.textContent || ''));
  });
  return pendingTxn.map(txn => {
    const date = (0, _moment.default)(txn[0], 'DD/MM/YY').toISOString();
    const amount = parseInt(txn[3], 10);
    return {
      type: _transactions.TransactionTypes.Normal,
      date,
      processedDate: date,
      originalAmount: amount,
      originalCurrency: _constants.SHEKEL_CURRENCY,
      chargedAmount: amount,
      description: txn[1],
      status: _transactions.TransactionStatuses.Pending
    };
  });
}

async function postLogin(page) {
  await Promise.race([(0, _elementsInteractions.waitUntilElementFound)(page, afterLoginSelector), (0, _elementsInteractions.waitUntilElementFound)(page, invalidPasswordSelector)]);
}

class MizrahiScraper extends _baseScraperWithBrowser.BaseScraperWithBrowser {
  getLoginOptions(credentials) {
    return {
      loginUrl: LOGIN_URL,
      fields: createLoginFields(credentials),
      submitButtonSelector,
      checkReadiness: async () => (0, _elementsInteractions.waitUntilElementDisappear)(this.page, loginSpinnerSelector),
      postAction: async () => postLogin(this.page),
      possibleResults: getPossibleLoginResults(this.page)
    };
  }

  async fetchData() {
    await this.navigateTo(OSH_PAGE, this.page);
    const request = await this.page.waitForRequest(TRANSACTIONS_REQUEST_URL);
    const data = CreateDataFromRequest(request, this.options.startDate);
    const headers = createHeadersFromRequest(request);
    const response = await (0, _fetch.fetchPostWithinPage)(this.page, TRANSACTIONS_REQUEST_URL, data, headers);

    if (!response || response.header.success === false) {
      return {
        success: false,
        errorType: _baseScraper.ScraperErrorTypes.Generic,
        errorMessage: `Error fetching transaction. Response message: ${response ? response.header.messages[0].text : ''}`
      };
    }

    const relevantRows = response.body.table.rows.filter(row => row.RecTypeSpecified);
    const oshTxn = convertTransactions(relevantRows);
    await this.navigateTo(PENDING_TRANSACTIONS_PAGE, this.page);
    const pendingTxn = await extractPendingTransactions(this.page);
    const allTxn = oshTxn.concat(pendingTxn);
    return {
      success: true,
      accounts: [{
        accountNumber: response.body.fields.AccountNumber,
        txns: allTxn
      }]
    };
  }

}

var _default = MizrahiScraper;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JhcGVycy9taXpyYWhpLnRzIl0sIm5hbWVzIjpbIkJBU0VfV0VCU0lURV9VUkwiLCJMT0dJTl9VUkwiLCJCQVNFX0FQUF9VUkwiLCJBRlRFUl9MT0dJTl9CQVNFX1VSTCIsIk9TSF9QQUdFIiwiVFJBTlNBQ1RJT05TX1JFUVVFU1RfVVJMIiwiUEVORElOR19UUkFOU0FDVElPTlNfUEFHRSIsIkNIQU5HRV9QQVNTV09SRF9VUkwiLCJEQVRFX0ZPUk1BVCIsIk1BWF9ST1dTX1BFUl9SRVFVRVNUIiwidXNlcm5hbWVTZWxlY3RvciIsInBhc3N3b3JkU2VsZWN0b3IiLCJzdWJtaXRCdXR0b25TZWxlY3RvciIsImludmFsaWRQYXNzd29yZFNlbGVjdG9yIiwiYWZ0ZXJMb2dpblNlbGVjdG9yIiwibG9naW5TcGlubmVyU2VsZWN0b3IiLCJjcmVhdGVMb2dpbkZpZWxkcyIsImNyZWRlbnRpYWxzIiwic2VsZWN0b3IiLCJ2YWx1ZSIsInVzZXJuYW1lIiwicGFzc3dvcmQiLCJnZXRQb3NzaWJsZUxvZ2luUmVzdWx0cyIsInBhZ2UiLCJMb2dpblJlc3VsdHMiLCJTdWNjZXNzIiwiSW52YWxpZFBhc3N3b3JkIiwiJCIsIkNoYW5nZVBhc3N3b3JkIiwiQ3JlYXRlRGF0YUZyb21SZXF1ZXN0IiwicmVxdWVzdCIsIm9wdGlvbnNTdGFydERhdGUiLCJkZWZhdWx0U3RhcnRNb21lbnQiLCJzdWJ0cmFjdCIsInN0YXJ0RGF0ZSIsInRvRGF0ZSIsInN0YXJ0TW9tZW50IiwibW9tZW50IiwibWF4IiwiZGF0YSIsIkpTT04iLCJwYXJzZSIsInBvc3REYXRhIiwiaW5Ub0RhdGUiLCJmb3JtYXQiLCJpbkZyb21EYXRlIiwidGFibGUiLCJtYXhSb3ciLCJjcmVhdGVIZWFkZXJzRnJvbVJlcXVlc3QiLCJtaXpyYWhpeHNyZnRva2VuIiwiaGVhZGVycyIsImNvbnZlcnRUcmFuc2FjdGlvbnMiLCJ0eG5zIiwibWFwIiwicm93IiwidHhuRGF0ZSIsIk1DMDJQZXVsYVRhYUVaIiwiSFRNTDVfRk1UIiwiREFURVRJTUVfTE9DQUxfU0VDT05EUyIsInRvSVNPU3RyaW5nIiwidHlwZSIsIlRyYW5zYWN0aW9uVHlwZXMiLCJOb3JtYWwiLCJpZGVudGlmaWVyIiwiTUMwMkFzbWFodGFNZWtvcml0RVoiLCJwYXJzZUludCIsInVuZGVmaW5lZCIsImRhdGUiLCJwcm9jZXNzZWREYXRlIiwib3JpZ2luYWxBbW91bnQiLCJNQzAyU2NodW1FWiIsIm9yaWdpbmFsQ3VycmVuY3kiLCJTSEVLRUxfQ1VSUkVOQ1kiLCJjaGFyZ2VkQW1vdW50IiwiZGVzY3JpcHRpb24iLCJNQzAyVG51YVRldXJFWiIsInN0YXR1cyIsIlRyYW5zYWN0aW9uU3RhdHVzZXMiLCJDb21wbGV0ZWQiLCJleHRyYWN0UGVuZGluZ1RyYW5zYWN0aW9ucyIsInBlbmRpbmdUeG4iLCJ0cnMiLCJ0ciIsIkFycmF5IiwiZnJvbSIsInF1ZXJ5U2VsZWN0b3JBbGwiLCJ0ZCIsInRleHRDb250ZW50IiwidHhuIiwiYW1vdW50IiwiUGVuZGluZyIsInBvc3RMb2dpbiIsIlByb21pc2UiLCJyYWNlIiwiTWl6cmFoaVNjcmFwZXIiLCJCYXNlU2NyYXBlcldpdGhCcm93c2VyIiwiZ2V0TG9naW5PcHRpb25zIiwibG9naW5VcmwiLCJmaWVsZHMiLCJjaGVja1JlYWRpbmVzcyIsInBvc3RBY3Rpb24iLCJwb3NzaWJsZVJlc3VsdHMiLCJmZXRjaERhdGEiLCJuYXZpZ2F0ZVRvIiwid2FpdEZvclJlcXVlc3QiLCJvcHRpb25zIiwicmVzcG9uc2UiLCJoZWFkZXIiLCJzdWNjZXNzIiwiZXJyb3JUeXBlIiwiU2NyYXBlckVycm9yVHlwZXMiLCJHZW5lcmljIiwiZXJyb3JNZXNzYWdlIiwibWVzc2FnZXMiLCJ0ZXh0IiwicmVsZXZhbnRSb3dzIiwiYm9keSIsInJvd3MiLCJmaWx0ZXIiLCJSZWNUeXBlU3BlY2lmaWVkIiwib3NoVHhuIiwiYWxsVHhuIiwiY29uY2F0IiwiYWNjb3VudHMiLCJhY2NvdW50TnVtYmVyIiwiQWNjb3VudE51bWJl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bUJBQW1CLENBQUNnRSxZQUFELENBQWxDO0FBRUEsVUFBTSxLQUFLWixVQUFMLENBQWdCakcseUJBQWhCLEVBQTJDLEtBQUtpQixJQUFoRCxDQUFOO0FBQ0EsVUFBTXlELFVBQVUsR0FBRyxNQUFNRCwwQkFBMEIsQ0FBQyxLQUFLeEQsSUFBTixDQUFuRDtBQUVBLFVBQU1rRyxNQUFNLEdBQUdELE1BQU0sQ0FBQ0UsTUFBUCxDQUFjMUMsVUFBZCxDQUFmO0FBRUEsV0FBTztBQUNMNEIsTUFBQUEsT0FBTyxFQUFFLElBREo7QUFFTGUsTUFBQUEsUUFBUSxFQUFFLENBQ1I7QUFDRUMsUUFBQUEsYUFBYSxFQUFFbEIsUUFBUSxDQUFDVSxJQUFULENBQWNsQixNQUFkLENBQXFCMkIsYUFEdEM7QUFFRXpFLFFBQUFBLElBQUksRUFBRXFFO0FBRlIsT0FEUTtBQUZMLEtBQVA7QUFTRDs7QUEvQ2lEOztlQWtEckMzQixjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQnO1xuaW1wb3J0IHsgUGFnZSwgUmVxdWVzdCB9IGZyb20gJ3B1cHBldGVlcic7XG5pbXBvcnQge1xuICBTSEVLRUxfQ1VSUkVOQ1ksXG59IGZyb20gJy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBwYWdlRXZhbEFsbCwgd2FpdFVudGlsRWxlbWVudERpc2FwcGVhciwgd2FpdFVudGlsRWxlbWVudEZvdW5kIH0gZnJvbSAnLi4vaGVscGVycy9lbGVtZW50cy1pbnRlcmFjdGlvbnMnO1xuaW1wb3J0IHsgZmV0Y2hQb3N0V2l0aGluUGFnZSB9IGZyb20gJy4uL2hlbHBlcnMvZmV0Y2gnO1xuaW1wb3J0IHtcbiAgVHJhbnNhY3Rpb24sIFRyYW5zYWN0aW9uU3RhdHVzZXMsIFRyYW5zYWN0aW9uVHlwZXMsXG59IGZyb20gJy4uL3RyYW5zYWN0aW9ucyc7XG5pbXBvcnQgeyBTY3JhcGVyQ3JlZGVudGlhbHMsIFNjcmFwZXJFcnJvclR5cGVzIH0gZnJvbSAnLi9iYXNlLXNjcmFwZXInO1xuaW1wb3J0IHsgQmFzZVNjcmFwZXJXaXRoQnJvd3NlciwgTG9naW5SZXN1bHRzLCBQb3NzaWJsZUxvZ2luUmVzdWx0cyB9IGZyb20gJy4vYmFzZS1zY3JhcGVyLXdpdGgtYnJvd3Nlcic7XG5cbmludGVyZmFjZSBTY3JhcGVkVHJhbnNhY3Rpb24ge1xuICBSZWNUeXBlU3BlY2lmaWVkOiBib29sZWFuO1xuICBNQzAyUGV1bGFUYWFFWjogc3RyaW5nO1xuICBNQzAyU2NodW1FWjogbnVtYmVyO1xuICBNQzAyQXNtYWh0YU1la29yaXRFWjogc3RyaW5nO1xuICBNQzAyVG51YVRldXJFWjogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgU2NyYXBlZFRyYW5zYWN0aW9uc1Jlc3VsdCB7XG4gIGhlYWRlcjoge1xuICAgIHN1Y2Nlc3M6IGJvb2xlYW47XG4gICAgbWVzc2FnZXM6IHsgdGV4dDogc3RyaW5nIH1bXTtcbiAgfTtcbiAgYm9keToge1xuICAgIGZpZWxkczoge1xuICAgICAgQWNjb3VudE51bWJlcjogc3RyaW5nO1xuICAgIH07XG4gICAgdGFibGU6IHtcbiAgICAgIHJvd3M6IFNjcmFwZWRUcmFuc2FjdGlvbltdO1xuICAgIH07XG4gIH07XG59XG5cbmNvbnN0IEJBU0VfV0VCU0lURV9VUkwgPSAnaHR0cHM6Ly93d3cubWl6cmFoaS10ZWZhaG90LmNvLmlsJztcbmNvbnN0IExPR0lOX1VSTCA9IGAke0JBU0VfV0VCU0lURV9VUkx9L2xvZ2luL2luZGV4Lmh0bWwjL2F1dGgtcGFnZS1oZWA7XG5jb25zdCBCQVNFX0FQUF9VUkwgPSAnaHR0cHM6Ly9tdG8ubWl6cmFoaS10ZWZhaG90LmNvLmlsJztcbmNvbnN0IEFGVEVSX0xPR0lOX0JBU0VfVVJMID0gL2h0dHBzOlxcL1xcL210b1xcLm1penJhaGktdGVmYWhvdFxcLmNvXFwuaWxcXC9uZ09ubGluZVxcL2luZGV4XFwuaHRtbCNcXC9tYWluXFwvdWlzLztcbmNvbnN0IE9TSF9QQUdFID0gYCR7QkFTRV9BUFBfVVJMfS9uZ09ubGluZS9pbmRleC5odG1sIy9tYWluL3Vpcy9vc2gvcDQyOC9gO1xuY29uc3QgVFJBTlNBQ1RJT05TX1JFUVVFU1RfVVJMID0gYCR7QkFTRV9BUFBfVVJMfS9PbmxpbmUvYXBpL1NreU9TSC9nZXQ0MjhJbmRleGA7XG5jb25zdCBQRU5ESU5HX1RSQU5TQUNUSU9OU19QQUdFID0gYCR7QkFTRV9BUFBfVVJMfS9PbmxpbmUvT3NoL3A0MjAuYXNweGA7XG5jb25zdCBDSEFOR0VfUEFTU1dPUkRfVVJMID0gYCR7QUZURVJfTE9HSU5fQkFTRV9VUkx9L21haW4vdWlzL2dlL2NoYW5nZVBhc3N3b3JkL2A7XG5jb25zdCBEQVRFX0ZPUk1BVCA9ICdERC9NTS9ZWVlZJztcbmNvbnN0IE1BWF9ST1dTX1BFUl9SRVFVRVNUID0gMTAwMDAwMDAwMDA7XG5cbmNvbnN0IHVzZXJuYW1lU2VsZWN0b3IgPSAnI2VtYWlsRGVza3RvcEhlYic7XG5jb25zdCBwYXNzd29yZFNlbGVjdG9yID0gJyNwYXNzd29yZElERGVza3RvcEhFQic7XG5jb25zdCBzdWJtaXRCdXR0b25TZWxlY3RvciA9ICcuZm9ybS1kZXNrdG9wIGJ1dHRvbic7XG5jb25zdCBpbnZhbGlkUGFzc3dvcmRTZWxlY3RvciA9ICdhW2hyZWYqPVwiaHR0cHM6Ly9zYy5taXpyYWhpLXRlZmFob3QuY28uaWwvU0NTZXJ2aWNlcy9TQy9QMDEwLmFzcHhcIl0nO1xuY29uc3QgYWZ0ZXJMb2dpblNlbGVjdG9yID0gJyNzdGlja3lIZWFkZXJTY3JvbGxSZWdpb24nO1xuY29uc3QgbG9naW5TcGlubmVyU2VsZWN0b3IgPSAnZGl2Lm5neC1vdmVybGF5LmxvYWRpbmctZm9yZWdyb3VuZCc7XG5cbmZ1bmN0aW9uIGNyZWF0ZUxvZ2luRmllbGRzKGNyZWRlbnRpYWxzOiBTY3JhcGVyQ3JlZGVudGlhbHMpIHtcbiAgcmV0dXJuIFtcbiAgICB7IHNlbGVjdG9yOiB1c2VybmFtZVNlbGVjdG9yLCB2YWx1ZTogY3JlZGVudGlhbHMudXNlcm5hbWUgfSxcbiAgICB7IHNlbGVjdG9yOiBwYXNzd29yZFNlbGVjdG9yLCB2YWx1ZTogY3JlZGVudGlhbHMucGFzc3dvcmQgfSxcbiAgXTtcbn1cblxuZnVuY3Rpb24gZ2V0UG9zc2libGVMb2dpblJlc3VsdHMocGFnZTogUGFnZSk6IFBvc3NpYmxlTG9naW5SZXN1bHRzIHtcbiAgcmV0dXJuIHtcbiAgICBbTG9naW5SZXN1bHRzLlN1Y2Nlc3NdOiBbQUZURVJfTE9HSU5fQkFTRV9VUkxdLFxuICAgIFtMb2dpblJlc3VsdHMuSW52YWxpZFBhc3N3b3JkXTogW2FzeW5jICgpID0+ICEhKGF3YWl0IHBhZ2UuJChpbnZhbGlkUGFzc3dvcmRTZWxlY3RvcikpXSxcbiAgICBbTG9naW5SZXN1bHRzLkNoYW5nZVBhc3N3b3JkXTogW0NIQU5HRV9QQVNTV09SRF9VUkxdLFxuICB9O1xufVxuXG5mdW5jdGlvbiBDcmVhdGVEYXRhRnJvbVJlcXVlc3QocmVxdWVzdDogUmVxdWVzdCwgb3B0aW9uc1N0YXJ0RGF0ZTogRGF0ZSkge1xuICBjb25zdCBkZWZhdWx0U3RhcnRNb21lbnQgPSBtb21lbnQoKS5zdWJ0cmFjdCgxLCAneWVhcnMnKTtcbiAgY29uc3Qgc3RhcnREYXRlID0gb3B0aW9uc1N0YXJ0RGF0ZSB8fCBkZWZhdWx0U3RhcnRNb21lbnQudG9EYXRlKCk7XG4gIGNvbnN0IHN0YXJ0TW9tZW50ID0gbW9tZW50Lm1heChkZWZhdWx0U3RhcnRNb21lbnQsIG1vbWVudChzdGFydERhdGUpKTtcblxuICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShyZXF1ZXN0LnBvc3REYXRhKCkgfHwgJ3t9Jyk7XG5cbiAgZGF0YS5pblRvRGF0ZSA9IG1vbWVudCgpLmZvcm1hdChEQVRFX0ZPUk1BVCk7XG4gIGRhdGEuaW5Gcm9tRGF0ZSA9IHN0YXJ0TW9tZW50LmZvcm1hdChEQVRFX0ZPUk1BVCk7XG4gIGRhdGEudGFibGUubWF4Um93ID0gTUFYX1JPV1NfUEVSX1JFUVVFU1Q7XG5cbiAgcmV0dXJuIGRhdGE7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUhlYWRlcnNGcm9tUmVxdWVzdChyZXF1ZXN0OiBSZXF1ZXN0KSB7XG4gIHJldHVybiB7XG4gICAgbWl6cmFoaXhzcmZ0b2tlbjogcmVxdWVzdC5oZWFkZXJzKCkubWl6cmFoaXhzcmZ0b2tlbixcbiAgICAnQ29udGVudC1UeXBlJzogcmVxdWVzdC5oZWFkZXJzKClbJ2NvbnRlbnQtdHlwZSddLFxuICB9O1xufVxuXG5cbmZ1bmN0aW9uIGNvbnZlcnRUcmFuc2FjdGlvbnModHhuczogU2NyYXBlZFRyYW5zYWN0aW9uW10pOiBUcmFuc2FjdGlvbltdIHtcbiAgcmV0dXJuIHR4bnMubWFwKChyb3cpID0+IHtcbiAgICBjb25zdCB0eG5EYXRlID0gbW9tZW50KHJvdy5NQzAyUGV1bGFUYWFFWiwgbW9tZW50LkhUTUw1X0ZNVC5EQVRFVElNRV9MT0NBTF9TRUNPTkRTKVxuICAgICAgLnRvSVNPU3RyaW5nKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogVHJhbnNhY3Rpb25UeXBlcy5Ob3JtYWwsXG4gICAgICBpZGVudGlmaWVyOiByb3cuTUMwMkFzbWFodGFNZWtvcml0RVogPyBwYXJzZUludChyb3cuTUMwMkFzbWFodGFNZWtvcml0RVosIDEwKSA6IHVuZGVmaW5lZCxcbiAgICAgIGRhdGU6IHR4bkRhdGUsXG4gICAgICBwcm9jZXNzZWREYXRlOiB0eG5EYXRlLFxuICAgICAgb3JpZ2luYWxBbW91bnQ6IHJvdy5NQzAyU2NodW1FWixcbiAgICAgIG9yaWdpbmFsQ3VycmVuY3k6IFNIRUtFTF9DVVJSRU5DWSxcbiAgICAgIGNoYXJnZWRBbW91bnQ6IHJvdy5NQzAyU2NodW1FWixcbiAgICAgIGRlc2NyaXB0aW9uOiByb3cuTUMwMlRudWFUZXVyRVosXG4gICAgICBzdGF0dXM6IFRyYW5zYWN0aW9uU3RhdHVzZXMuQ29tcGxldGVkLFxuICAgIH07XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBleHRyYWN0UGVuZGluZ1RyYW5zYWN0aW9ucyhwYWdlOiBQYWdlKTogUHJvbWlzZTxUcmFuc2FjdGlvbltdPiB7XG4gIGNvbnN0IHBlbmRpbmdUeG4gPSBhd2FpdCBwYWdlRXZhbEFsbChwYWdlLCAndHIucmdSb3cnLCBbXSwgKHRycykgPT4ge1xuICAgIHJldHVybiB0cnMubWFwKCh0cikgPT4gQXJyYXkuZnJvbSh0ci5xdWVyeVNlbGVjdG9yQWxsKCd0ZCcpLCAodGQ6IEhUTUxUYWJsZURhdGFDZWxsRWxlbWVudCkgPT4gdGQudGV4dENvbnRlbnQgfHwgJycpKTtcbiAgfSk7XG5cbiAgcmV0dXJuIHBlbmRpbmdUeG4ubWFwKCh0eG4pID0+IHtcbiAgICBjb25zdCBkYXRlID0gbW9tZW50KHR4blswXSwgJ0REL01NL1lZJykudG9JU09TdHJpbmcoKTtcbiAgICBjb25zdCBhbW91bnQgPSBwYXJzZUludCh0eG5bM10sIDEwKTtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogVHJhbnNhY3Rpb25UeXBlcy5Ob3JtYWwsXG4gICAgICBkYXRlLFxuICAgICAgcHJvY2Vzc2VkRGF0ZTogZGF0ZSxcbiAgICAgIG9yaWdpbmFsQW1vdW50OiBhbW91bnQsXG4gICAgICBvcmlnaW5hbEN1cnJlbmN5OiBTSEVLRUxfQ1VSUkVOQ1ksXG4gICAgICBjaGFyZ2VkQW1vdW50OiBhbW91bnQsXG4gICAgICBkZXNjcmlwdGlvbjogdHhuWzFdLFxuICAgICAgc3RhdHVzOiBUcmFuc2FjdGlvblN0YXR1c2VzLlBlbmRpbmcsXG4gICAgfTtcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBvc3RMb2dpbihwYWdlOiBQYWdlKSB7XG4gIGF3YWl0IFByb21pc2UucmFjZShbXG4gICAgd2FpdFVudGlsRWxlbWVudEZvdW5kKHBhZ2UsIGFmdGVyTG9naW5TZWxlY3RvciksXG4gICAgd2FpdFVudGlsRWxlbWVudEZvdW5kKHBhZ2UsIGludmFsaWRQYXNzd29yZFNlbGVjdG9yKSxcbiAgXSk7XG59XG5cbmNsYXNzIE1penJhaGlTY3JhcGVyIGV4dGVuZHMgQmFzZVNjcmFwZXJXaXRoQnJvd3NlciB7XG4gIGdldExvZ2luT3B0aW9ucyhjcmVkZW50aWFsczogU2NyYXBlckNyZWRlbnRpYWxzKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGxvZ2luVXJsOiBMT0dJTl9VUkwsXG4gICAgICBmaWVsZHM6IGNyZWF0ZUxvZ2luRmllbGRzKGNyZWRlbnRpYWxzKSxcbiAgICAgIHN1Ym1pdEJ1dHRvblNlbGVjdG9yLFxuICAgICAgY2hlY2tSZWFkaW5lc3M6IGFzeW5jICgpID0+IHdhaXRVbnRpbEVsZW1lbnREaXNhcHBlYXIodGhpcy5wYWdlLCBsb2dpblNwaW5uZXJTZWxlY3RvciksXG4gICAgICBwb3N0QWN0aW9uOiBhc3luYyAoKSA9PiBwb3N0TG9naW4odGhpcy5wYWdlKSxcbiAgICAgIHBvc3NpYmxlUmVzdWx0czogZ2V0UG9zc2libGVMb2dpblJlc3VsdHModGhpcy5wYWdlKSxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgZmV0Y2hEYXRhKCkge1xuICAgIGF3YWl0IHRoaXMubmF2aWdhdGVUbyhPU0hfUEFHRSwgdGhpcy5wYWdlKTtcbiAgICBjb25zdCByZXF1ZXN0ID0gYXdhaXQgdGhpcy5wYWdlLndhaXRGb3JSZXF1ZXN0KFRSQU5TQUNUSU9OU19SRVFVRVNUX1VSTCk7XG4gICAgY29uc3QgZGF0YSA9IENyZWF0ZURhdGFGcm9tUmVxdWVzdChyZXF1ZXN0LCB0aGlzLm9wdGlvbnMuc3RhcnREYXRlKTtcbiAgICBjb25zdCBoZWFkZXJzID0gY3JlYXRlSGVhZGVyc0Zyb21SZXF1ZXN0KHJlcXVlc3QpO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaFBvc3RXaXRoaW5QYWdlPFNjcmFwZWRUcmFuc2FjdGlvbnNSZXN1bHQ+KHRoaXMucGFnZSxcbiAgICAgIFRSQU5TQUNUSU9OU19SRVFVRVNUX1VSTCwgZGF0YSwgaGVhZGVycyk7XG5cbiAgICBpZiAoIXJlc3BvbnNlIHx8IHJlc3BvbnNlLmhlYWRlci5zdWNjZXNzID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yVHlwZTogU2NyYXBlckVycm9yVHlwZXMuR2VuZXJpYyxcbiAgICAgICAgZXJyb3JNZXNzYWdlOlxuICAgICAgICAgIGBFcnJvciBmZXRjaGluZyB0cmFuc2FjdGlvbi4gUmVzcG9uc2UgbWVzc2FnZTogJHtyZXNwb25zZSA/IHJlc3BvbnNlLmhlYWRlci5tZXNzYWdlc1swXS50ZXh0IDogJyd9YCxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgcmVsZXZhbnRSb3dzID0gcmVzcG9uc2UuYm9keS50YWJsZS5yb3dzLmZpbHRlcigocm93KSA9PiByb3cuUmVjVHlwZVNwZWNpZmllZCk7XG4gICAgY29uc3Qgb3NoVHhuID0gY29udmVydFRyYW5zYWN0aW9ucyhyZWxldmFudFJvd3MpO1xuXG4gICAgYXdhaXQgdGhpcy5uYXZpZ2F0ZVRvKFBFTkRJTkdfVFJBTlNBQ1RJT05TX1BBR0UsIHRoaXMucGFnZSk7XG4gICAgY29uc3QgcGVuZGluZ1R4biA9IGF3YWl0IGV4dHJhY3RQZW5kaW5nVHJhbnNhY3Rpb25zKHRoaXMucGFnZSk7XG5cbiAgICBjb25zdCBhbGxUeG4gPSBvc2hUeG4uY29uY2F0KHBlbmRpbmdUeG4pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBhY2NvdW50czogW1xuICAgICAgICB7XG4gICAgICAgICAgYWNjb3VudE51bWJlcjogcmVzcG9uc2UuYm9keS5maWVsZHMuQWNjb3VudE51bWJlcixcbiAgICAgICAgICB0eG5zOiBhbGxUeG4sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH07XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTWl6cmFoaVNjcmFwZXI7XG4iXX0=